<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RDR2 ‚Äî –ü–æ–≤–æ–∑–∫–∏</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin:0; background:#000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #map { height:100vh; width:100vw; background:#000; }

    /* Popup shell */
    .leaflet-popup-content-wrapper { background: transparent; box-shadow:none; }
    .leaflet-popup-content { margin: 0; }
    .leaflet-popup-tip { background: rgba(40,28,16,.92); }

    /* RDR2-like card */
    .rdrCard {
      width: 520px;
      border-radius: 26px;
      overflow: hidden;
      background: rgba(45, 30, 18, 0.92);
      color: #f3e6cf;
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      position: relative;
      backdrop-filter: blur(2px);
    }

    .rdrTop {
      position: relative;
      height: 290px;
      background: #1a110a;
    }

    .rdrImg {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(.95) contrast(1.05);
    }

    .rdrClose {
      position:absolute;
      top: 12px;
      right: 12px;
      width: 34px;
      height: 34px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      color: #fff;
      background: rgba(0,0,0,.35);
      font-size: 20px;
      line-height: 34px;
    }
    .rdrClose:hover { background: rgba(0,0,0,.55); }

    .navBtn {
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      border: 0;
      border-radius: 999px;
      cursor: pointer;
      color: #fff;
      background: rgba(0,0,0,.35);
      font-size: 24px;
      line-height: 48px;
    }
    .navBtn:hover { background: rgba(0,0,0,.55); }
    .navLeft { left: 14px; }
    .navRight { right: 14px; }

    .dotsWrap {
      position:absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
    }
    .dot {
      width: 8px; height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.35);
    }
    .dot.active { background: rgba(255,255,255,.9); }

    .rdrBody {
      padding: 14px 16px 18px;
      background: linear-gradient(to bottom, rgba(45,30,18,.92), rgba(30,20,12,.92));
    }

    .titleRow {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .titleRow .name {
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .titleRow .idPill {
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 800;
      color: #ffe6b2;
      white-space: nowrap;
    }

    .grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .field {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px;
    }
    .field label {
      display:block;
      font-size: 12px;
      opacity: .85;
      margin-bottom: 6px;
    }
    .field input, .field textarea {
      width: 100%;
      box-sizing: border-box;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 10px;
      padding: 10px 10px;
      color: #f3e6cf;
      outline: none;
      font-size: 14px;
    }
    .field textarea { resize: vertical; min-height: 68px; }

    .rowFull { grid-column: 1 / -1; }

    .actions {
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .btn {
      border: 0;
      border-radius: 14px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 800;
      background: rgba(255,255,255,.10);
      color: #f3e6cf;
      border: 1px solid rgba(255,255,255,.14);
    }
    .btn:hover { background: rgba(255,255,255,.16); }

    .hint {
      font-size: 12px;
      opacity: .85;
      line-height: 1.25;
    }

    /* responsive */
    @media (max-width: 620px){
      .rdrCard { width: 92vw; }
      .rdrTop { height: 220px; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  // =========================
  // 1) –†–û–ó–ú–Ü–† –ö–ê–†–¢–ò–ù–ö–ò map.jpg
  // =========================
  // –Ø–∫—â–æ –∫–∞—Ä—Ç–∞ –Ω–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–ª–∞–∑–∏—Ç—å/—Ä–æ–∑—Ç—è–≥—É—î—Ç—å—Å—è ‚Äî —Å–∫–∞–∂–∏ —Ä–æ–∑–º—ñ—Ä map.jpg —ñ —è –ø—ñ–¥–∫–∞–∂—É —Ç–æ—á–Ω—ñ —á–∏—Å–ª–∞.
  const MAP_WIDTH  = 2200;
  const MAP_HEIGHT = 1712;

  // =========================
  // 2) MAP INIT
  // =========================
  const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 2 });
  const bounds = [[0,0],[MAP_HEIGHT, MAP_WIDTH]];
  L.imageOverlay('map.jpg', bounds).addTo(map);
  map.fitBounds(bounds);
  map.setMaxBounds(bounds);

  // =========================
  // 3) ICON (—Ç–≤—ñ–π wagon.jpg)
  // =========================
  const wagonIcon = L.icon({
    iconUrl: 'wagon.jpg',
    iconSize: [44, 44],
    iconAnchor: [22, 44],
    popupAnchor: [0, -38]
  });

  // =========================
  // 4) STORAGE (–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ–π/–¥–∞–Ω–∏—Ö)
  // =========================
  const STORAGE_KEY = "rdr2_wagons_v1";

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e) {
      return null;
    }
  }
  function saveState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // =========================
  // 5) 15 –ü–û–í–û–ó–û–ö (–¥–µ—Ñ–æ–ª—Ç)
  // =========================
  const defaultWagons = Array.from({length: 15}, (_, i) => {
    const id = i + 1;
    return {
      id,
      name: `–ü–æ–≤–æ–∑–∫–∞ #${id}`,
      price: 100 + id * 10,          // —Ü—ñ–Ω–∞
      weight: 200 + id * 5,          // –≤–∞–≥–∞
      seats: 2,                      // –º—ñ—Å—Ü—è
      deliveries: 0,                 // –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–æ–∫
      needToBuy: "–ì—Ä–æ—à—ñ + –¥–æ–∫—É–º–µ–Ω—Ç", // —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —â–æ–± –∫—É–ø–∏—Ç–∏
      note: "–ü—Ä–∏–º—ñ—Ç–∫–∞...",
      // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ (—Å—Ç–∞—Ä—Ç–æ–≤—ñ, –ø–æ—Ç—ñ–º —Ç–∏ –ø–µ—Ä–µ—Ç—è–≥—É—î—à)
      y: 3600 + (i%5)*220,
      x: 3600 + (Math.floor(i/5))*260,
      // —Ñ–æ—Ç–æ (–º–æ–∂–µ—à –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞ —Å–≤–æ—ó / –∞–±–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç)
      photos: [
        "https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1200&q=70",
        "https://images.unsplash.com/photo-1520962917960-0b0d8a8b5b8a?auto=format&fit=crop&w=1200&q=70"
      ]
    };
  });

  // –Ø–∫—â–æ –≤–∂–µ —â–æ—Å—å –∑–±–µ—Ä—ñ–≥–∞–ª–æ—Å—è ‚Äî –±–µ—Ä–µ–º–æ –∑–≤—ñ–¥—Ç–∏
  const saved = loadState();
  const wagons = saved?.wagons ?? defaultWagons;

  // =========================
  // 6) HELPERS
  // =========================
  function wagonById(id) {
    return wagons.find(w => w.id === id);
  }

  function renderDots(count, activeIndex) {
    let html = `<div class="dotsWrap">`;
    for (let i=0;i<count;i++){
      html += `<div class="dot ${i===activeIndex ? "active":""}"></div>`;
    }
    html += `</div>`;
    return html;
  }

  function cardHtml(w, photoIndex) {
    const photos = (w.photos && w.photos.length) ? w.photos : ["wagon.jpg"];
    const idx = Math.max(0, Math.min(photoIndex ?? 0, photos.length-1));

    return `
      <div class="rdrCard" data-id="${w.id}" data-idx="${idx}">
        <div class="rdrTop">
          <img class="rdrImg" src="${photos[idx]}" alt="photo">

          <button class="rdrClose" data-action="close">√ó</button>

          ${photos.length>1 ? `<button class="navBtn navLeft" data-action="prev">‚Äπ</button>` : ``}
          ${photos.length>1 ? `<button class="navBtn navRight" data-action="next">‚Ä∫</button>` : ``}

          ${photos.length>1 ? renderDots(photos.length, idx) : ``}
        </div>

        <div class="rdrBody">
          <div class="titleRow">
            <div class="name">${escapeHtml(w.name)}</div>
            <div class="idPill">#${w.id}</div>
          </div>

          <div class="grid">
            <div class="field">
              <label>–¶—ñ–Ω–∞ üí∞</label>
              <input type="number" step="1" data-field="price" value="${w.price}">
            </div>

            <div class="field">
              <label>–í–∞–≥–∞ ‚öñÔ∏è</label>
              <input type="number" step="1" data-field="weight" value="${w.weight}">
            </div>

            <div class="field">
              <label>–ú—ñ—Å—Ü—è ü™ë</label>
              <input type="number" step="1" data-field="seats" value="${w.seats}">
            </div>

            <div class="field">
              <label>–î–æ—Å—Ç–∞–≤–æ–∫ üì¶</label>
              <input type="number" step="1" data-field="deliveries" value="${w.deliveries}">
            </div>

            <div class="field rowFull">
              <label>–©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ, —â–æ–± –∫—É–ø–∏—Ç–∏ ‚úÖ</label>
              <input type="text" data-field="needToBuy" value="${escapeAttr(w.needToBuy)}">
            </div>

            <div class="field rowFull">
              <label>–ü—Ä–∏–º—ñ—Ç–∫–∞ üìù</label>
              <textarea data-field="note">${escapeHtml(w.note)}</textarea>
            </div>

            <div class="field rowFull">
              <label>–§–æ—Ç–æ (—á–µ—Ä–µ–∑ –∫–æ–º—É) üì∑</label>
              <input type="text" data-field="photos" value="${escapeAttr((w.photos||[]).join(', '))}">
            </div>
          </div>

          <div class="actions">
            <button class="btn" data-action="save">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button class="btn" data-action="resetPos">‚Ü©Ô∏è –°–∫–∏–Ω—É—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>
            <div class="hint">
              ‚úÖ –ü–æ–≤–æ–∑–∫—É –º–æ–∂–Ω–∞ <b>–ø–µ—Ä–µ—Ç—è–≥—É–≤–∞—Ç–∏</b> –ø–æ –∫–∞—Ä—Ç—ñ.<br>
              –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∑–±–µ—Ä–µ–∂—É—Ç—å—Å—è –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏.
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll("\n"," ");
  }

  // =========================
  // 7) MARKERS + POPUPS
  // =========================
  const markers = new Map(); // id -> marker

  function openWagonPopup(w, photoIndex = 0) {
    const marker = markers.get(w.id);
    if (!marker) return;

    const popup = L.popup({ closeButton: false, maxWidth: 540 })
      .setLatLng([w.y, w.x])
      .setContent(cardHtml(w, photoIndex))
      .openOn(map);

    // –ø—ñ—Å–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è - –ø—ñ–¥–∫–ª—é—á–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ —Ç–∞ —ñ–Ω–ø—É—Ç–∏
    setTimeout(() => bindCardControls(w.id), 0);
  }

  function bindCardControls(id){
    const card = document.querySelector(`.rdrCard[data-id="${id}"]`);
    if (!card) return;
    const w = wagonById(id);
    if (!w) return;

    const getIdx = () => parseInt(card.getAttribute("data-idx"), 10) || 0;

    const photos = (w.photos && w.photos.length) ? w.photos : ["wagon.jpg"];

    const closeBtn = card.querySelector('[data-action="close"]');
    if (closeBtn) closeBtn.onclick = () => map.closePopup();

    const prevBtn = card.querySelector('[data-action="prev"]');
    const nextBtn = card.querySelector('[data-action="next"]');

    if (prevBtn) prevBtn.onclick = () => {
      const idx = (getIdx() - 1 + photos.length) % photos.length;
      openWagonPopup(w, idx);
    };
    if (nextBtn) nextBtn.onclick = () => {
      const idx = (getIdx() + 1) % photos.length;
      openWagonPopup(w, idx);
    };

    const saveBtn = card.querySelector('[data-action="save"]');
    if (saveBtn) saveBtn.onclick = () => {
      // –∑—á–∏—Ç—É—î–º–æ –ø–æ–ª—è
      card.querySelectorAll('[data-field]').forEach(el => {
        const field = el.getAttribute('data-field');
        if (!field) return;

        if (field === 'price' || field === 'weight' || field === 'seats' || field === 'deliveries'){
          w[field] = parseInt(el.value || "0", 10);
        } else if (field === 'photos') {
          w.photos = String(el.value || "")
            .split(',')
            .map(x => x.trim())
            .filter(Boolean);
        } else {
          w[field] = el.value ?? "";
        }
      });

      // –∑–±–µ—Ä–µ–≥—Ç–∏
      saveState({ wagons });
      // –æ–Ω–æ–≤–∏—Ç–∏ –ø–æ–ø–∞–ø (—â–æ–± –∑–∞–≥–æ–ª–æ–≤–æ–∫/—Ñ–æ—Ç–æ –æ–Ω–æ–≤–∏–ª–∏—Å—å)
      openWagonPopup(w, getIdx());
    };

    const resetBtn = card.querySelector('[data-action="resetPos"]');
    if (resetBtn) resetBtn.onclick = () => {
      // –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤ –¥–µ—Ñ–æ–ª—Ç –¥–ª—è —Ü—å–æ–≥–æ id
      const d = defaultWagons.find(x => x.id === w.id);
      if (!d) return;
      w.x = d.x; w.y = d.y;
      const marker = markers.get(w.id);
      marker.setLatLng([w.y, w.x]);
      saveState({ wagons });
      openWagonPopup(w, getIdx());
    };
  }

  // —Å—Ç–≤–æ—Ä—é—î–º–æ –º–∞—Ä–∫–µ—Ä–∏
  wagons.forEach(w => {
    const marker = L.marker([w.y, w.x], {
      icon: wagonIcon,
      draggable: true
    }).addTo(map);

    markers.set(w.id, marker);

    marker.on('click', () => openWagonPopup(w, 0));

    // –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
    marker.on('dragend', (e) => {
      const ll = e.target.getLatLng();
      w.y = ll.lat;
      w.x = ll.lng;
      saveState({ wagons });
    });
  });

  // =========================
  // 8) –ö–õ–Ü–ö –ü–û –ö–ê–†–¢–Ü = –ö–û–û–†–î–ò–ù–ê–¢–ò
  // =========================
  map.on('click', (e) => {
    alert(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:\nY(lat): ${Math.round(e.latlng.lat)}\nX(lng): ${Math.round(e.latlng.lng)}`);
  });
</script>
</body>
</html>
