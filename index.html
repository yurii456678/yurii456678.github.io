<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RDR2 — Повозки</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body{
      margin:0;
      background:#D2B791;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    #map{
      position: relative;
      height:100vh;
      width:100vw;
      background:#D2B791;
    }

    /* віньєтка */
    #map::after{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 250;
      background: radial-gradient(circle at 50% 45%,
        rgba(0,0,0,0) 45%,
        rgba(0,0,0,.16) 75%,
        rgba(0,0,0,.30) 100%);
      mix-blend-mode: multiply;
    }

    /* Reset button */
    .resetBtn{
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 9999;
      border: 0;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 900;
      background: rgba(35,24,14,.90);
      color: #f3e6cf;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .resetBtn:hover{ background: rgba(35,24,14,.98); }

    /* Popup shell */
    .leaflet-popup-content-wrapper { background: transparent; box-shadow:none; }
    .leaflet-popup-content { margin: 0; }
    .leaflet-popup-tip { background: rgba(40,28,16,.92); }

    /* Marker */
    .pinWrap{
      position: relative;
      width: 44px; height: 44px;
      transform: translate(-50%, -100%);
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.45));
      user-select: none;
      pointer-events: auto;
    }
    .pinBadge{
      position:absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 3px 7px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color: #f3e6cf;
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      white-space: nowrap;
    }
    .pinIcon{
      position:absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .pinIcon img{ width: 26px; height: 26px; display:block; }

    /* Card */
    .rdrCard{
      width: 540px;
      border-radius: 26px;
      overflow: hidden;
      background: rgba(45, 30, 18, 0.92);
      color: #f3e6cf;
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      position: relative;
      backdrop-filter: blur(2px);
    }

    .rdrTop{ position: relative; height: 290px; background: #1a110a; }
    .rdrImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
      filter: saturate(.95) contrast(1.05);
      background: rgba(0,0,0,.15);
    }

    .rdrClose{
      position:absolute; top: 12px; right: 12px;
      width: 34px; height: 34px;
      border: 0; border-radius: 10px;
      cursor: pointer;
      color: #fff;
      background: rgba(0,0,0,.35);
      font-size: 20px; line-height: 34px;
      z-index: 5;
    }
    .rdrClose:hover { background: rgba(0,0,0,.55); }

    .navBtn{
      position:absolute; top:50%;
      transform: translateY(-50%);
      width: 48px; height: 48px;
      border: 0; border-radius: 999px;
      cursor: pointer;
      color:#fff;
      background: rgba(0,0,0,.35);
      font-size: 24px; line-height: 48px;
      z-index: 5;
    }
    .navBtn:hover{ background: rgba(0,0,0,.55); }
    .navLeft{ left: 14px; }
    .navRight{ right: 14px; }

    .dotsWrap{
      position:absolute;
      bottom: 12px; left: 50%;
      transform: translateX(-50%);
      display:flex; gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      z-index: 5;
    }
    .dot{ width: 8px; height: 8px; border-radius:999px; background: rgba(255,255,255,.35); }
    .dot.active{ background: rgba(255,255,255,.9); }

    .rdrBody{
      padding: 14px 16px 16px;
      background: linear-gradient(to bottom, rgba(45,30,18,.92), rgba(30,20,12,.92));
    }

    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .titleRow .name{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .titleRow .idPill{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
      color: #ffe6b2;
      white-space: nowrap;
    }

    .statsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
    }
    .stat{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .stat .label{ font-size: 12px; opacity: .88; margin-bottom: 6px; }
    .stat .value{ font-size: 18px; font-weight: 900; letter-spacing: .2px; }

    .priceRow{
      display:flex;
      align-items:baseline;
      justify-content:flex-start;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .priceLabel{
      font-size: 14px;
      opacity: .90;
      font-weight: 900;
      color: #f3e6cf;
    }
    .priceValue{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: .4px;
      color: #ffe6b2;
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    /* ====== GROUP PICKER (вибір повозки в групі) ====== */
    .pickRow{
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .pickTitle{
      font-size: 12px;
      opacity: .85;
      font-weight: 900;
      margin-bottom: 8px;
    }
    .pickBtns{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pickBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: #f3e6cf;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
    }
    .pickBtn.active{
      background: rgba(255,255,255,.18);
      color: #ffe6b2;
    }

    @media (max-width: 620px){
      .rdrCard { width: 92vw; }
      .rdrTop { height: 220px; }
      .statsGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<button class="resetBtn" id="resetBtn">Reset save</button>
<div id="map"></div>

<script>
  // ===== PATH (GitHub Pages) =====
  const basePath = location.pathname.endsWith("/")
    ? location.pathname
    : location.pathname.replace(/[^/]+$/, "");

  const bust = `?v=${Date.now()}`;
  const MAP_URL   = basePath + "map.jpg" + bust;
  const WAGON_URL = basePath + "wagon.png" + bust;

  // ===== STORAGE =====
  const STORAGE_KEY = "rdr2_wagons_v4";
  function loadState(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); } catch(e){ return null; } }
  function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  document.getElementById("resetBtn").onclick = () => {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem("rdr2_groups_v1");
    location.reload();
  };

  // ===== DATA =====
  const WAGONS_DATA = [
    { id: 1,  title: "Возик", code: "W1",  price: 3100, deliveriesToBuy: 20, passengers: 2, slots: 0, kg: 0, photos: ["W1.jpg"],  x: 1874, y: 747 },
    { id: 2,  title: "Возик", code: "W2",  price: 6000, deliveriesToBuy: 80, passengers: 8, slots: 30, kg: 50, photos: ["W2.jpg"],  x: 1969, y: 1182 },
    { id: 3,  title: "Возик", code: "W3",  price: 3850, deliveriesToBuy: 30, passengers: 3, slots: 40, kg: 100, photos: ["W3.jpg"],  x: 1621, y: 989 },
    { id: 4,  title: "Возик", code: "W4",  price: 3050, deliveriesToBuy: 20, passengers: 2, slots: 0, kg: 0, photos: ["W4.jpg"], x: null, y: null },
    { id: 5,  title: "Возик", code: "W5",  price: 3350, deliveriesToBuy: 20, passengers: 2, slots: 40, kg: 175, photos: ["W5.jpg"], x: null, y: null },
    { id: 6,  title: "Возик", code: "W6",  price: 3250, deliveriesToBuy: 20, passengers: 2, slots: 30, kg: 125, photos: ["W6.jpg"], x: null, y: null },
    { id: 7,  title: "Возик", code: "W7",  price: 2800, deliveriesToBuy: 15, passengers: 1, slots: 30, kg: 100, photos: ["W7.jpg"], x: null, y: null },
    { id: 8,  title: "Возик", code: "W8",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: ["W8.jpg"], x: null, y: null },
    { id: 9,  title: "Возик", code: "W9",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: ["W9.jpg"], x: null, y: null },
    { id: 10, title: "Возик", code: "W10", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: ["W10.jpg"], x: null, y: null },
    { id: 11, title: "Возик", code: "W11", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: ["W11.jpg"], x: null, y: null },
    { id: 12, title: "Возик", code: "W12", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: ["W12.jpg"], x: null, y: null },
    { id: 13, title: "Возик", code: "W13", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: ["W13.jpg"], x: null, y: null },
    { id: 14, title: "Возик", code: "W14", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: ["W14.jpg"], x: null, y: null },
    { id: 15, title: "Возик", code: "W15", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: ["W15.jpg"], x: null, y: null },
  ];

  // ===== HELPERS =====
  const num = (n) => (Number.isFinite(Number(n)) ? Number(n) : 0);
  const fmtInt = (n) => String(Math.round(num(n)));
  function fmtPriceDot(n){
    const s = Math.round(num(n)).toString();
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");

  function resolveUrl(u){
    const s = String(u || "").trim();
    if (!s) return "";
    if (s.startsWith("http://") || s.startsWith("https://") || s.startsWith("data:")) return s;
    return basePath + s + bust;
  }

  function renderDots(count, activeIndex){
    let html = `<div class="dotsWrap">`;
    for (let i=0;i<count;i++) html += `<div class="dot ${i===activeIndex ? "active":""}"></div>`;
    html += `</div>`;
    return html;
  }

  // ===== GROUP PICKER UI =====
  function groupHeaderHtml(ids, activeId){
    if (!ids || ids.length <= 1) return "";
    const buttons = ids.map(id => {
      const active = id === activeId ? "active" : "";
      return `<button class="pickBtn ${active}" data-pick="${id}" type="button">#${id}</button>`;
    }).join("");

    return `
      <div class="pickRow">
        <div class="pickTitle">Вибери повозку:</div>
        <div class="pickBtns">${buttons}</div>
      </div>
    `;
  }

  // ===== CARD =====
  function cardHtml(w, photoIndex){
    const rawPhotos = (w.photos && w.photos.length) ? w.photos : ["wagon.png"];
    const photos = rawPhotos.map(resolveUrl).filter(Boolean);
    const idx = Math.max(0, Math.min(photoIndex ?? 0, photos.length-1));
    const src = photos[idx] || WAGON_URL;

    return `
      <div class="rdrCard" data-id="${w.id}" data-idx="${idx}">
        <div class="rdrTop">
          <img class="rdrImg" src="${src}" alt="photo">
          <button class="rdrClose" data-action="close" type="button">×</button>

          ${photos.length>1 ? `<button class="navBtn navLeft" data-action="prev" type="button">‹</button>` : ``}
          ${photos.length>1 ? `<button class="navBtn navRight" data-action="next" type="button">›</button>` : ``}
          ${photos.length>1 ? renderDots(photos.length, idx) : ``}
        </div>

        <div class="rdrBody">
          <div class="titleRow">
            <div class="name">${esc(w.title || "Возик")}</div>
            <div class="idPill">#${w.id}</div>
          </div>

          <div class="statsGrid">
            <div class="stat"><div class="label">Пасажирів</div><div class="value">${fmtInt(w.passengers)}</div></div>
            <div class="stat"><div class="label">Слоти</div><div class="value">${fmtInt(w.slots)}</div></div>
            <div class="stat"><div class="label">Кг</div><div class="value">${fmtInt(w.kg)}</div></div>
            <div class="stat"><div class="label">Потрібно доставок для купівлі</div><div class="value">${fmtInt(w.deliveriesToBuy)}</div></div>
          </div>

          <div class="priceRow">
            <span class="priceLabel">Ціна</span>
            <span class="priceValue">${fmtPriceDot(w.price)} $</span>
          </div>
        </div>
      </div>
    `;
  }

  function groupCardHtml(wagons, groupIds, activeId){
    const w = wagons.find(x => x.id === activeId);
    if (!w) return "";
    const raw = cardHtml(w, 0);
    return raw.replace(`<div class="rdrBody">`, `<div class="rdrBody">${groupHeaderHtml(groupIds, activeId)}`);
  }

  // ===== MARKER HTML =====
  function markerHtml(label){
    return `
      <div class="pinWrap">
        <div class="pinBadge">${label}</div>
        <div class="pinIcon"><img src="${WAGON_URL}" alt=""></div>
      </div>
    `;
  }

  function groupLabel(ids){
    if (ids.length === 1) return `#${ids[0]}`;
    const min = Math.min(...ids);
    const max = Math.max(...ids);
    return `#${min}-${max}`;
  }

  // ===== BIND GROUP POPUP (FIX CLICK!) =====
  function bindGroupPopup(wagons, groupIds, activeId, marker){
    const root = document.querySelector(`.rdrCard[data-id="${activeId}"]`);
    if (!root) return;

    // ✅ КЛЮЧОВЕ: щоб кліки не "пробивали" на карту/маркер
    L.DomEvent.disableClickPropagation(root);
    L.DomEvent.disableScrollPropagation(root);

    // fallback для фото
    const imgEl = root.querySelector(".rdrImg");
    if (imgEl) imgEl.onerror = () => { imgEl.src = WAGON_URL; };

    // close
    const closeBtn = root.querySelector('[data-action="close"]');
    if (closeBtn) {
      closeBtn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        marker.closePopup();
      };
    }

    // перемикання повозок у групі
    root.querySelectorAll("[data-pick]").forEach(btn => {
      btn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();

        const id = parseInt(btn.getAttribute("data-pick"), 10);
        if (!Number.isFinite(id)) return;

        marker.setPopupContent(groupCardHtml(wagons, groupIds, id));
        setTimeout(() => bindGroupPopup(wagons, groupIds, id, marker), 0);
      };
    });
  }

  // ===== PRELOAD MAP =====
  const preload = new Image();
  preload.onload = () => initMap(preload.width, preload.height);
  preload.onerror = () => alert("Не можу завантажити map.jpg. Перевір файл map.jpg поруч з index.html");
  preload.src = MAP_URL;

  function initMap(MAP_WIDTH, MAP_HEIGHT){
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomControl: true,
      zoomAnimation: false,
      markerZoomAnimation: false,
      fadeAnimation: false
    });

    const bounds = [[0,0],[MAP_HEIGHT, MAP_WIDTH]];
    L.imageOverlay(MAP_URL, bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    // ===== load saved wagon positions =====
    const saved = loadState();
    const savedById = new Map((saved?.wagons || []).map(w => [w.id, w]));

    const wagons = WAGONS_DATA.map((w, idx) => {
      const s = savedById.get(w.id);
      const out = { ...w };

      if (s && typeof s.x === "number" && typeof s.y === "number"){
        out.x = s.x; out.y = s.y;
      }
      if (out.x == null || out.y == null){
        out.x = Math.round(MAP_WIDTH * (0.55 + (idx%5)*0.04));
        out.y = Math.round(MAP_HEIGHT * (0.25 + Math.floor(idx/5)*0.06));
      }
      return out;
    });

    // ===== YOUR GROUPS =====
    const GROUPS_DEFAULT = [
      { ids: [1], x: wagons.find(w=>w.id===1).x, y: wagons.find(w=>w.id===1).y },
      { ids: [2], x: wagons.find(w=>w.id===2).x, y: wagons.find(w=>w.id===2).y },
      { ids: [3], x: wagons.find(w=>w.id===3).x, y: wagons.find(w=>w.id===3).y },

      { ids: [4,5,6,7], x: 1315, y: 1181 },
      { ids: [8,9],      x: wagons.find(w=>w.id===8).x,  y: wagons.find(w=>w.id===8).y },
      { ids: [10,11,12], x: wagons.find(w=>w.id===10).x, y: wagons.find(w=>w.id===10).y },
      { ids: [13],       x: wagons.find(w=>w.id===13).x, y: wagons.find(w=>w.id===13).y },
      { ids: [14,15],    x: wagons.find(w=>w.id===14).x, y: wagons.find(w=>w.id===14).y },
    ];

    // ===== load saved group positions =====
    let GROUPS = GROUPS_DEFAULT;
    try{
      const raw = localStorage.getItem("rdr2_groups_v1");
      if (raw){
        const savedGroups = JSON.parse(raw);
        if (Array.isArray(savedGroups) && savedGroups.length){
          const key = (ids) => ids.slice().sort((a,b)=>a-b).join("-");
          const mapSaved = new Map(savedGroups.map(g => [key(g.ids), g]));
          GROUPS = GROUPS_DEFAULT.map(g => {
            const sg = mapSaved.get(key(g.ids));
            return (sg && typeof sg.x==="number" && typeof sg.y==="number") ? { ...g, x: sg.x, y: sg.y } : g;
          });
        }
      }
    }catch(e){}

    // ===== create markers by groups =====
    GROUPS.forEach(g => {
      const label = groupLabel(g.ids);

      const icon = L.divIcon({
        className: "",
        html: markerHtml(label),
        iconSize: [44, 44],
        iconAnchor: [0, 0]
      });

      const marker = L.marker([g.y, g.x], { icon, draggable: true }).addTo(map);

      function openGroup(activeId){
        marker.bindPopup(
          groupCardHtml(wagons, g.ids, activeId),
          { closeButton: false, maxWidth: 600, autoPan: true, keepInView: true }
        ).openPopup();

        setTimeout(() => bindGroupPopup(wagons, g.ids, activeId, marker), 0);
      }

      marker.on("click", () => openGroup(g.ids[0]));

      marker.on("dragend", (e) => {
        const ll = e.target.getLatLng();
        g.y = ll.lat;
        g.x = ll.lng;

        const toSave = GROUPS.map(x => ({ ids: x.ids, x: x.x, y: x.y }));
        localStorage.setItem("rdr2_groups_v1", JSON.stringify(toSave));
      });
    });

    map.on('click', (e) => {
      alert(`Координати:\nY(lat): ${Math.round(e.latlng.lat)}\nX(lng): ${Math.round(e.latlng.lng)}`);
    });
  }
</script>
</body>
</html>
