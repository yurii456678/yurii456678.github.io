<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RDR2 ‚Äî –ü–æ–≤–æ–∑–∫–∏ / –ö–æ–Ω–∏–∫–∏</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --bg: #D2B791;
      --ui: rgba(35,24,14,.92);
      --ui2: rgba(45,30,18,.92);
      --text: #f3e6cf;
      --gold: #ffe6b2;
    }

    html, body{
      height: 100%;
      margin:0;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow: hidden;
    }

    #map{
      position: relative;
      height:100%;
      width:100%;
      background: var(--bg);
    }

    /* –í—ñ–Ω—å—î—Ç–∫–∞ */
    #map::after{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 250;
      background: radial-gradient(circle at 50% 45%,
        rgba(0,0,0,0) 45%,
        rgba(0,0,0,.16) 75%,
        rgba(0,0,0,.30) 100%);
      mix-blend-mode: multiply;
    }

    /* ===== Top Bar Buttons ===== */
    .topBar{
      position: fixed;
      top: calc(10px + env(safe-area-inset-top));
      left: calc(10px + env(safe-area-inset-left));
      right: calc(10px + env(safe-area-inset-right));
      display: flex;
      gap: 10px;
      z-index: 9999;
      pointer-events: none;
      flex-wrap: wrap;           /* ‚úÖ –Ω–∞ –º–æ–±—ñ–ª—Ü—ñ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—å—Å—è */
      align-items: center;
    }

    .btn{
      pointer-events: auto;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(35,24,14,.90);
      color: var(--text);
      font-weight: 900;
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(35,24,14,.98); }

    .btnWide{ flex: 1; }
    .btnSmall{ min-width: 118px; }

    /* ‚úÖ –ù–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω–∞—Ö –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—é—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à—ñ */
    @media (max-width: 420px){
      .btn{
        padding: 9px 10px;
        border-radius: 12px;
        font-size: 14px;
        gap: 8px;
      }
      .btnSmall{ min-width: 0; flex: 1; }
      .topBar{ gap: 8px; }
    }

    /* ‚úÖ –ó—É–º-–∫–Ω–æ–ø–∫–∏ –Ω–∏–∂—á–µ topBar */
    .leaflet-top.leaflet-left {
      top: calc(86px + env(safe-area-inset-top));
      left: calc(10px + env(safe-area-inset-left));
    }
    @media (max-width: 420px){
      .leaflet-top.leaflet-left {
        top: calc(94px + env(safe-area-inset-top));
      }
    }

    /* Popup shell */
    .leaflet-popup-content-wrapper { background: transparent; box-shadow:none; }
    .leaflet-popup-content { margin: 0; }
    .leaflet-popup-tip { background: rgba(40,28,16,.92); }
    .leaflet-popup{ margin-bottom: 12px; }

    /* ===== Marker ===== */
    .pinWrap{
      position: relative;
      width: 44px; height: 44px;
      transform: translate(-50%, -100%);
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.45));
      user-select: none;
      pointer-events: auto;
    }
    .pinBadge{
      position:absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 3px 7px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      white-space: nowrap;
    }
    .pinIcon{
      position:absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .pinIcon img{ width: 26px; height: 26px; display:block; }

    /* ===== Card ===== */
    .rdrCard{
      width: 540px;
      border-radius: 26px;
      overflow: hidden;
      background: var(--ui2);
      color: var(--text);
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      position: relative;
      backdrop-filter: blur(2px);
    }
    @media (max-width: 720px){
      .rdrCard{
        width: min(92vw, 560px);
        max-height: calc(100vh - 140px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      }
    }

    .rdrTop{
      position: relative;
      height: 290px;
      background: #1a110a;
      flex: 0 0 auto;
    }
    @media (max-width: 720px){
      .rdrTop{ height: 200px; }
    }

    .rdrImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
      filter: saturate(.95) contrast(1.05);
      background: rgba(0,0,0,.15);
    }

    .rdrClose{
      position:absolute; top: 12px; right: 12px;
      width: 34px; height: 34px;
      border: 0; border-radius: 10px;
      cursor: pointer;
      color: #fff;
      background: rgba(0,0,0,.35);
      font-size: 20px; line-height: 34px;
      z-index: 10;
      -webkit-tap-highlight-color: transparent;
    }
    .rdrClose:hover { background: rgba(0,0,0,.55); }

    .navBtn{
      position:absolute; top:50%;
      transform: translateY(-50%);
      width: 48px; height: 48px;
      border: 0; border-radius: 999px;
      cursor: pointer;
      color:#fff;
      background: rgba(0,0,0,.35);
      font-size: 24px; line-height: 48px;
      z-index: 10;
      -webkit-tap-highlight-color: transparent;
    }
    .navBtn:hover{ background: rgba(0,0,0,.55); }
    .navLeft{ left: 14px; }
    .navRight{ right: 14px; }

    .dotsWrap{
      position:absolute;
      bottom: 12px; left: 50%;
      transform: translateX(-50%);
      display:flex; gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      z-index: 10;
    }
    .dot{ width: 8px; height: 8px; border-radius:999px; background: rgba(255,255,255,.35); }
    .dot.active{ background: rgba(255,255,255,.9); }

    .rdrBody{
      padding: 14px 16px 16px;
      background: linear-gradient(to bottom, rgba(45,30,18,.92), rgba(30,20,12,.92));
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      max-height: 420px;
    }
    @media (max-width: 720px){
      .rdrBody{
        max-height: calc(100vh - 140px - 200px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      }
    }

    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .titleRow .name{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .titleRow .idPill{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
      color: var(--gold);
      white-space: nowrap;
    }

    .statsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
    }
    .stat{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .stat .label{ font-size: 12px; opacity: .88; margin-bottom: 6px; }
    .stat .value{ font-size: 18px; font-weight: 900; letter-spacing: .2px; }

    .priceRow{
      display:flex;
      align-items:baseline;
      justify-content:flex-start;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .priceLabel{
      font-size: 14px;
      opacity: .90;
      font-weight: 900;
      color: var(--text);
    }
    .priceValue{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: .4px;
      color: var(--gold);
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    /* ===== Group picker (wagons) ===== */
    .pickRow{
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .pickTitle{
      font-size: 12px;
      opacity: .85;
      font-weight: 900;
      margin-bottom: 8px;
    }
    .pickBtns{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pickBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pickBtn.active{
      background: rgba(255,255,255,.18);
      color: var(--gold);
    }

    /* ===== Left Drawer ===== */
    .drawer{
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      width: min(420px, 92vw);
      background: rgba(20,14,8,.92);
      backdrop-filter: blur(6px);
      border-right: 1px solid rgba(255,255,255,.10);
      transform: translateX(-105%);
      transition: transform .22s ease;
      z-index: 9998;
      display:flex;
      flex-direction: column;
      padding-top: calc(12px + env(safe-area-inset-top));
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .drawer.open{ transform: translateX(0); }

    .drawerHeader{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      color: var(--text);
    }
    .drawerTitle{
      font-weight: 1000;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .drawerClose{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .drawerList{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .wagonRow{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .wagonRow:hover{ background: rgba(255,255,255,.09); }

    .wagonLeft{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .wagonMain{
      font-weight: 1000;
      font-size: 18px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .wagonSub{
      opacity: .85;
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pricePill{
      flex: 0 0 auto;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--gold);
      font-weight: 1000;
      font-size: 18px;
    }

    .scrim{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.25);
      z-index: 9997;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .scrim.show{
      opacity: 1;
      pointer-events: auto;
    }

    /* prevent popup from being under topbar on mobile */
    @media (max-width: 720px){
      .leaflet-popup{ margin-top: calc(10px + env(safe-area-inset-top)); }
    }

    /* ===== Coords floating button (–∑–∞–º—ñ—Å—Ç—å topBar) ===== */
    .fab{
      position: fixed;
      right: calc(12px + env(safe-area-inset-right));
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 9999;
      pointer-events: none;
    }
    .fab .btn{
      pointer-events: auto;
      border-radius: 999px;
      padding: 12px 14px;
      min-width: 0;
    }
  </style>
</head>

<body>
  <!-- LEFT DRAWER -->
  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="drawerTitle">–°–ø–∏—Å–æ–∫</div>
      <button class="drawerClose" id="drawerClose" type="button">√ó</button>
    </div>
    <div class="drawerList" id="drawerList"></div>
  </aside>

  <!-- TOP BAR (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø—Ä–∏–±—Ä–∞–ª–∏ –∑–≤—ñ–¥—Å–∏) -->
  <div class="topBar">
    <button class="btn btnSmall" id="listBtn" type="button">‚ò∞ –°–ø–∏—Å–æ–∫</button>
    <button class="btn btnSmall" id="toggleBtn" type="button">üêé –ö–æ–Ω–∏–∫–∏</button>
    <button class="btn btnSmall" id="reloadBtn" type="button">‚ü≥ –û–Ω–æ–≤–∏—Ç–∏</button>
  </div>

  <!-- FLOATING COORDS BUTTON -->
  <div class="fab">
    <button class="btn" id="coordsBtn" type="button">üìç –í–∏–º–∫</button>
  </div>

  <div id="map"></div>

<script>
  // ===== PATH (GitHub Pages safe) =====
  const basePath = location.pathname.endsWith("/")
    ? location.pathname
    : location.pathname.replace(/[^/]+$/, "");
  const bust = `?v=${Date.now()}`;

  const MAP_URL   = basePath + "map.jpg" + bust;
  const WAGON_URL = basePath + "wagon.png" + bust;
  const HORSE_URL = basePath + "horse.png" + bust; // –¥–æ–¥–∞–π horse.png –ø–æ—Ä—É—á

  // ===== DATA =====
  function cityById(id){
    if (id === 1) return "Saint Denis";
    if (id === 2) return "Van Horn";
    if (id === 3) return "Dewberry Creerk";
    if ([4,5,6,7].includes(id)) return "Valentine";
    if ([8,9].includes(id)) return "Gorge";
    if ([10,11,12].includes(id)) return "Strawberry";
    if (id === 13) return "Blackwater";
    if ([14,15].includes(id)) return "Tumbleweed";
    return "";
  }

  const WAGONS_DATA = [
    { id: 1,  title: "–í–æ–∑–∏–∫", price: 3100, deliveriesToBuy: 20, passengers: 2,  slots: 0,  kg: 0,   photos: ["W1.jpg"]  },
    { id: 2,  title: "–í–æ–∑–∏–∫", price: 6000, deliveriesToBuy: 80, passengers: 8,  slots: 30, kg: 50,  photos: ["W2.jpg"]  },
    { id: 3,  title: "–í–æ–∑–∏–∫", price: 3850, deliveriesToBuy: 30, passengers: 3,  slots: 40, kg: 100, photos: ["W3.jpg"]  },
    { id: 4,  title: "–í–æ–∑–∏–∫", price: 3050, deliveriesToBuy: 20, passengers: 2,  slots: 0,  kg: 0,   photos: ["W4.jpg"]  },
    { id: 5,  title: "–í–æ–∑–∏–∫", price: 3350, deliveriesToBuy: 20, passengers: 2,  slots: 40, kg: 175, photos: ["W5.jpg"]  },
    { id: 6,  title: "–í–æ–∑–∏–∫", price: 3250, deliveriesToBuy: 20, passengers: 2,  slots: 30, kg: 125, photos: ["W6.jpg"]  },
    { id: 7,  title: "–í–æ–∑–∏–∫", price: 2800, deliveriesToBuy: 15, passengers: 1,  slots: 30, kg: 100, photos: ["W7.jpg"]  },
    { id: 8,  title: "–í–æ–∑–∏–∫", price: 2750, deliveriesToBuy: 10, passengers: 1,  slots: 30, kg: 50,  photos: ["W8.jpg"]  },
    { id: 9,  title: "–í–æ–∑–∏–∫", price: 3000, deliveriesToBuy: 20, passengers: 2,  slots: 0,  kg: 0,   photos: ["W9.jpg"]  },
    { id: 10, title: "–í–æ–∑–∏–∫", price: 5250, deliveriesToBuy: 60, passengers: 6,  slots: 30, kg: 100, photos: ["W10.jpg"] },
    { id: 11, title: "–í–æ–∑–∏–∫", price: 8000, deliveriesToBuy: 120,passengers: 12, slots: 30, kg: 50,  photos: ["W11.jpg"] },
    { id: 12, title: "–í–æ–∑–∏–∫", price: 7250, deliveriesToBuy: 100,passengers: 10, slots: 30, kg: 50,  photos: ["W12.jpg"] },
    { id: 13, title: "–í–æ–∑–∏–∫", price: 2500, deliveriesToBuy: 5, passengers: 1,  slots: 30, kg: 50,  photos: ["W13.jpg"] },
    { id: 14, title: "–í–æ–∑–∏–∫", price: 6500, deliveriesToBuy: 80, passengers: 6,  slots: 50, kg: 350, photos: ["W14.jpg"] },
    { id: 15, title: "–í–æ–∑–∏–∫", price: 8250, deliveriesToBuy: 120,passengers: 12, slots: 30, kg: 150, photos: ["W15.jpg"] },
  ].map(w => ({ ...w, city: cityById(w.id) }));

  // ‚úÖ –ö–û–ù–ò–ö–ò (–ø—Ä–∏–∫–ª–∞–¥). –î–æ–¥–∞–≤–∞–π —Å–≤–æ—ó.
  const HORSES_DATA = [
    { id: 1, title: "–ö—ñ–Ω—å", price: 450, photos: ["H1.jpg"], x: 1315, y: 1181 },
    { id: 2, title: "–ö—ñ–Ω—å", price: 900, photos: ["H2.jpg"], x: 1318, y: 1172 },
  ];

  // –ì–†–£–ü–ò –ø–æ–≤–æ–∑–æ–∫ (–æ–¥–∏–Ω –º–∞—Ä–∫–µ—Ä –Ω–∞ –≥—Ä—É–ø—É)
  const GROUPS = [
    { ids: [1],        x: 1874, y: 747  },
    { ids: [2],        x: 1969, y: 1182 },
    { ids: [3],        x: 1621, y: 989  },
    { ids: [4,5,6,7],  x: 1315, y: 1181 },
    { ids: [8,9],      x: 1129, y: 1491 },
    { ids: [10,11,12], x: 1046, y: 922  },
    { ids: [13],       x: 1222, y: 763  },
    { ids: [14,15],    x: 318,  y: 443  },
  ];

  // ===== HELPERS =====
  const num = (n) => (Number.isFinite(Number(n)) ? Number(n) : 0);
  const fmtInt = (n) => String(Math.round(num(n)));
  function fmtPriceDot(n){
    const s = Math.round(num(n)).toString();
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");

  function resolveUrl(u){
    const s = String(u || "").trim();
    if (!s) return "";
    if (s.startsWith("http://") || s.startsWith("https://") || s.startsWith("data:")) return s;
    return basePath + s + bust;
  }

  function renderDots(count, activeIndex){
    let html = `<div class="dotsWrap">`;
    for (let i=0;i<count;i++) html += `<div class="dot ${i===activeIndex ? "active":""}"></div>`;
    html += `</div>`;
    return html;
  }

  function groupLabel(ids){
    if (ids.length === 1) return `#${ids[0]}`;
    const min = Math.min(...ids);
    const max = Math.max(...ids);
    return `#${min}-${max}`;
  }

  function markerHtml(label, iconUrl){
    return `
      <div class="pinWrap">
        <div class="pinBadge">${label}</div>
        <div class="pinIcon"><img src="${iconUrl}" alt=""></div>
      </div>
    `;
  }

  // ===== GROUP PICKER UI (wagons) =====
  function groupHeaderHtml(ids, activeId){
    if (!ids || ids.length <= 1) return "";
    const buttons = ids.map(id => {
      const active = id === activeId ? "active" : "";
      return `<button class="pickBtn ${active}" data-pick="${id}" type="button">#${id}</button>`;
    }).join("");

    return `
      <div class="pickRow">
        <div class="pickTitle">–í–∏–±–µ—Ä–∏ –ø–æ–≤–æ–∑–∫—É:</div>
        <div class="pickBtns">${buttons}</div>
      </div>
    `;
  }

  // ===== CARD (wagons) =====
  function cardHtml(w, photoIndex){
    const rawPhotos = (w.photos && w.photos.length) ? w.photos : ["wagon.png"];
    const photos = rawPhotos.map(resolveUrl).filter(Boolean);
    const idx = Math.max(0, Math.min(photoIndex ?? 0, photos.length-1));
    const src = photos[idx] || WAGON_URL;

    return `
      <div class="rdrCard" data-id="${w.id}" data-idx="${idx}">
        <div class="rdrTop">
          <img class="rdrImg" src="${src}" alt="photo">
          <button class="rdrClose" data-action="close" type="button">√ó</button>

          ${photos.length>1 ? `<button class="navBtn navLeft" data-action="prev" type="button">‚Äπ</button>` : ``}
          ${photos.length>1 ? `<button class="navBtn navRight" data-action="next" type="button">‚Ä∫</button>` : ``}
          ${photos.length>1 ? renderDots(photos.length, idx) : ``}
        </div>

        <div class="rdrBody">
          <div class="titleRow">
            <div class="name">${esc(w.title || "–í–æ–∑–∏–∫")}</div>
            <div class="idPill">#${w.id}</div>
          </div>

          <div class="statsGrid">
            <div class="stat"><div class="label">–ü–∞—Å–∞–∂–∏—Ä—ñ–≤</div><div class="value">${fmtInt(w.passengers)}</div></div>
            <div class="stat"><div class="label">–°–ª–æ—Ç–∏</div><div class="value">${fmtInt(w.slots)}</div></div>
            <div class="stat"><div class="label">–ö–≥</div><div class="value">${fmtInt(w.kg)}</div></div>
            <div class="stat"><div class="label">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Å—Ç–∞–≤–æ–∫ –¥–ª—è –∫—É–ø—ñ–≤–ª—ñ</div><div class="value">${fmtInt(w.deliveriesToBuy)}</div></div>
          </div>

          <div class="priceRow">
            <span class="priceLabel">–¶—ñ–Ω–∞</span>
            <span class="priceValue">${fmtPriceDot(w.price)} $</span>
          </div>
        </div>
      </div>
    `;
  }

  function groupCardHtml(wagons, groupIds, activeId, photoIndex = 0){
    const w = wagons.find(x => x.id === activeId);
    if (!w) return "";
    const raw = cardHtml(w, photoIndex);
    return raw.replace(`<div class="rdrBody">`, `<div class="rdrBody">${groupHeaderHtml(groupIds, activeId)}`);
  }

  // ===== CARD (horses: —Ç—ñ–ª—å–∫–∏ —Ñ–æ—Ç–æ + —Ü—ñ–Ω–∞) =====
  function horseCardHtml(h, photoIndex){
    const rawPhotos = (h.photos && h.photos.length) ? h.photos : ["horse.png"];
    const photos = rawPhotos.map(resolveUrl).filter(Boolean);
    const idx = Math.max(0, Math.min(photoIndex ?? 0, photos.length-1));
    const src = photos[idx] || HORSE_URL;

    return `
      <div class="rdrCard" data-hid="${h.id}" data-idx="${idx}">
        <div class="rdrTop">
          <img class="rdrImg" src="${src}" alt="photo">
          <button class="rdrClose" data-action="close" type="button">√ó</button>

          ${photos.length>1 ? `<button class="navBtn navLeft" data-action="prev" type="button">‚Äπ</button>` : ``}
          ${photos.length>1 ? `<button class="navBtn navRight" data-action="next" type="button">‚Ä∫</button>` : ``}
          ${photos.length>1 ? renderDots(photos.length, idx) : ``}
        </div>

        <div class="rdrBody">
          <div class="titleRow">
            <div class="name">${esc(h.title || "–ö—ñ–Ω—å")}</div>
            <div class="idPill">#${h.id}</div>
          </div>

          <div class="priceRow">
            <span class="priceLabel">–¶—ñ–Ω–∞</span>
            <span class="priceValue">${fmtPriceDot(h.price)} $</span>
          </div>
        </div>
      </div>
    `;
  }

  // ===== Drawer =====
  const drawer = document.getElementById("drawer");
  const scrim  = document.getElementById("scrim");
  const drawerList = document.getElementById("drawerList");
  const drawerTitleEl = document.getElementById("drawerTitle");

  function openDrawer(){
    drawer.classList.add("open");
    scrim.classList.add("show");
    drawer.setAttribute("aria-hidden", "false");
  }
  function closeDrawer(){
    drawer.classList.remove("open");
    scrim.classList.remove("show");
    drawer.setAttribute("aria-hidden", "true");
  }

  document.getElementById("listBtn").onclick = openDrawer;
  document.getElementById("drawerClose").onclick = closeDrawer;
  scrim.onclick = closeDrawer;

  // ===== Buttons =====
  document.getElementById("reloadBtn").onclick = () => location.reload();

  let coordsEnabled = false;
  const coordsBtn = document.getElementById("coordsBtn");
  function updateCoordsBtn(){
    coordsBtn.textContent = coordsEnabled ? "üìç –£–≤—ñ–º–∫" : "üìç –í–∏–º–∫";
  }
  coordsBtn.onclick = () => {
    coordsEnabled = !coordsEnabled;
    updateCoordsBtn();
  };
  updateCoordsBtn();

  // ===== PRELOAD MAP =====
  const preload = new Image();
  preload.onload = () => initMap(preload.width, preload.height);
  preload.onerror = () => alert("–ù–µ –º–æ–∂—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ map.jpg. –ü–µ—Ä–µ–≤—ñ—Ä —Ñ–∞–π–ª map.jpg –ø–æ—Ä—É—á –∑ index.html");
  preload.src = MAP_URL;

  function initMap(MAP_WIDTH, MAP_HEIGHT){
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomControl: true,
      zoomAnimation: false,
      markerZoomAnimation: false,
      fadeAnimation: false,
      tap: true
    });

    const bounds = [[0,0],[MAP_HEIGHT, MAP_WIDTH]];
    L.imageOverlay(MAP_URL, bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    // ===== LAYERS (–ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è) =====
    const wagonsLayer = L.layerGroup().addTo(map);
    const horsesLayer = L.layerGroup(); // —Å–ø–æ—á–∞—Ç–∫—É —Å—Ö–æ–≤–∞–Ω–æ
    let currentMode = "wagons"; // "wagons" | "horses"

    // ===== helpers for wagon groups =====
    const wagonById = new Map(WAGONS_DATA.map(w => [w.id, w]));
    const groupByWagonId = new Map();
    GROUPS.forEach((g, idx) => g.ids.forEach(id => groupByWagonId.set(id, idx)));

    // ===== create wagon markers (groups) =====
    const markersByGroupIndex = new Map();

    function openGroupPopup(groupIndex, activeId, photoIndex = 0){
      const g = GROUPS[groupIndex];
      const marker = markersByGroupIndex.get(groupIndex);
      if (!g || !marker) return;

      const html = groupCardHtml(WAGONS_DATA, g.ids, activeId, photoIndex);

      marker.bindPopup(html, {
        closeButton: false,
        maxWidth: 600,
        autoPan: true,
        keepInView: true,
        autoPanPaddingTopLeft: [14, 110],
        autoPanPaddingBottomRight: [14, 14],
        className: "rdrPopup"
      }).openPopup();

      setTimeout(() => bindGroupPopup(g.ids, activeId, marker), 0);
    }

    function bindGroupPopup(groupIds, activeId, marker){
      const root = document.querySelector(`.rdrCard[data-id="${activeId}"]`);
      if (!root) return;

      L.DomEvent.disableClickPropagation(root);
      L.DomEvent.disableScrollPropagation(root);

      const w = wagonById.get(activeId);
      const photos = ((w?.photos && w.photos.length) ? w.photos : ["wagon.png"]).map(resolveUrl).filter(Boolean);

      const getIdx = () => parseInt(root.getAttribute("data-idx"), 10) || 0;

      const imgEl = root.querySelector(".rdrImg");
      if (imgEl) imgEl.onerror = () => { imgEl.src = WAGON_URL; };

      const closeBtn = root.querySelector('[data-action="close"]');
      if (closeBtn) closeBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); marker.closePopup(); };

      const prevBtn = root.querySelector('[data-action="prev"]');
      const nextBtn = root.querySelector('[data-action="next"]');

      if (prevBtn && photos.length > 1){
        prevBtn.onclick = (e) => {
          e.preventDefault(); e.stopPropagation();
          const idx = (getIdx() - 1 + photos.length) % photos.length;
          const groupIndex = groupByWagonId.get(activeId);
          openGroupPopup(groupIndex, activeId, idx);
        };
      }

      if (nextBtn && photos.length > 1){
        nextBtn.onclick = (e) => {
          e.preventDefault(); e.stopPropagation();
          const idx = (getIdx() + 1) % photos.length;
          const groupIndex = groupByWagonId.get(activeId);
          openGroupPopup(groupIndex, activeId, idx);
        };
      }

      root.querySelectorAll("[data-pick]").forEach(btn => {
        btn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const id = parseInt(btn.getAttribute("data-pick"), 10);
          const groupIndex = groupByWagonId.get(id);
          if (!Number.isFinite(id) || groupIndex == null) return;
          openGroupPopup(groupIndex, id, 0);
        };
      });
    }

    GROUPS.forEach((g, idx) => {
      const icon = L.divIcon({
        className: "",
        html: markerHtml(groupLabel(g.ids), WAGON_URL),
        iconSize: [44, 44],
        iconAnchor: [0, 0]
      });

      const marker = L.marker([g.y, g.x], {
        icon,
        draggable: false,
        keyboard: false
      }).addTo(wagonsLayer);

      markersByGroupIndex.set(idx, marker);
      marker.on("click", () => openGroupPopup(idx, g.ids[0], 0));
    });

    // ===== HORSE MARKERS (–ø–æ–∫–∏ –±–µ–∑ –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è) =====
    const horseMarkers = new Map();

    function openHorsePopup(horseId, photoIndex = 0){
      const h = HORSES_DATA.find(x => x.id === horseId);
      const marker = horseMarkers.get(horseId);
      if (!h || !marker) return;

      marker.bindPopup(horseCardHtml(h, photoIndex), {
        closeButton: false,
        maxWidth: 600,
        autoPan: true,
        keepInView: true,
        autoPanPaddingTopLeft: [14, 110],
        autoPanPaddingBottomRight: [14, 14],
        className: "rdrPopup"
      }).openPopup();

      setTimeout(() => {
        const root = document.querySelector(`.rdrCard[data-hid="${horseId}"]`);
        if (!root) return;

        L.DomEvent.disableClickPropagation(root);
        L.DomEvent.disableScrollPropagation(root);

        const photos = ((h.photos && h.photos.length) ? h.photos : ["horse.png"]).map(resolveUrl).filter(Boolean);
        const getIdx = () => parseInt(root.getAttribute("data-idx"), 10) || 0;

        const imgEl = root.querySelector(".rdrImg");
        if (imgEl) imgEl.onerror = () => { imgEl.src = HORSE_URL; };

        const closeBtn = root.querySelector('[data-action="close"]');
        if (closeBtn) closeBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); marker.closePopup(); };

        const prevBtn = root.querySelector('[data-action="prev"]');
        const nextBtn = root.querySelector('[data-action="next"]');

        if (prevBtn && photos.length > 1){
          prevBtn.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            const idx = (getIdx() - 1 + photos.length) % photos.length;
            openHorsePopup(horseId, idx);
          };
        }

        if (nextBtn && photos.length > 1){
          nextBtn.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            const idx = (getIdx() + 1) % photos.length;
            openHorsePopup(horseId, idx);
          };
        }
      }, 0);
    }

    HORSES_DATA.forEach(h => {
      const icon = L.divIcon({
        className: "",
        html: markerHtml(`H#${h.id}`, HORSE_URL),
        iconSize: [44, 44],
        iconAnchor: [0, 0]
      });

      const marker = L.marker([h.y, h.x], {
        icon,
        draggable: false,
        keyboard: false
      }).addTo(horsesLayer);

      horseMarkers.set(h.id, marker);
      marker.on("click", () => openHorsePopup(h.id, 0));
    });

    // ===== DRAWER rendering (–ø—ñ–¥ —Ä–µ–∂–∏–º) =====
    function renderDrawer(){
      if (currentMode === "wagons"){
        drawerTitleEl.textContent = "–°–ø–∏—Å–æ–∫ –ø–æ–≤–æ–∑–æ–∫";
        drawerList.innerHTML = WAGONS_DATA
          .slice()
          .sort((a,b) => a.id - b.id)
          .map(w => `
            <div class="wagonRow" data-type="wagon" data-id="${w.id}">
              <div class="wagonLeft">
                <div class="wagonMain">#${w.id} ‚Äî ${esc(w.title || "–í–æ–∑–∏–∫")}</div>
                <div class="wagonSub">${esc(w.city || "")}</div>
              </div>
              <div class="pricePill">${fmtPriceDot(w.price)} $</div>
            </div>
          `).join("");
      } else {
        drawerTitleEl.textContent = "–°–ø–∏—Å–æ–∫ –∫–æ–Ω–∏–∫—ñ–≤";
        drawerList.innerHTML = HORSES_DATA
          .slice()
          .sort((a,b) => a.id - b.id)
          .map(h => `
            <div class="wagonRow" data-type="horse" data-id="${h.id}">
              <div class="wagonLeft">
                <div class="wagonMain">H#${h.id} ‚Äî ${esc(h.title || "–ö—ñ–Ω—å")}</div>
                <div class="wagonSub">–ù–∞ –º–∞–ø—ñ</div>
              </div>
              <div class="pricePill">${fmtPriceDot(h.price)} $</div>
            </div>
          `).join("");
      }

      drawerList.querySelectorAll(".wagonRow").forEach(row => {
        row.onclick = () => {
          const type = row.getAttribute("data-type");
          const id = parseInt(row.getAttribute("data-id"), 10);
          if (!Number.isFinite(id)) return;

          closeDrawer();

          if (type === "wagon"){
            const groupIndex = groupByWagonId.get(id);
            if (groupIndex == null) return;
            const g = GROUPS[groupIndex];
            map.panTo([g.y, g.x], { animate: true, duration: 0.35 });
            setTimeout(() => openGroupPopup(groupIndex, id, 0), 220);
          } else {
            const h = HORSES_DATA.find(x => x.id === id);
            if (!h) return;
            map.panTo([h.y, h.x], { animate: true, duration: 0.35 });
            setTimeout(() => openHorsePopup(id, 0), 220);
          }
        };
      });
    }

    // ===== MODE toggle =====
    const toggleBtn = document.getElementById("toggleBtn");

    function applyMode(){
      map.closePopup();

      if (currentMode === "wagons"){
        if (map.hasLayer(horsesLayer)) map.removeLayer(horsesLayer);
        if (!map.hasLayer(wagonsLayer)) wagonsLayer.addTo(map);
        toggleBtn.textContent = "üêé –ö–æ–Ω–∏–∫–∏";
      } else {
        if (map.hasLayer(wagonsLayer)) map.removeLayer(wagonsLayer);
        if (!map.hasLayer(horsesLayer)) horsesLayer.addTo(map);
        toggleBtn.textContent = "üõí –ü–æ–≤–æ–∑–∫–∏";
      }

      renderDrawer();
    }

    toggleBtn.onclick = () => {
      currentMode = (currentMode === "wagons") ? "horses" : "wagons";
      applyMode();
    };

    applyMode();

    // ===== Coordinates click (toggleable) =====
    map.on('click', (e) => {
      if (!coordsEnabled) return;
      alert(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:\nY(lat): ${Math.round(e.latlng.lat)}\nX(lng): ${Math.round(e.latlng.lng)}`);
    });
  }
</script>
</body>
</html>
