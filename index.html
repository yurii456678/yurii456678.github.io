<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RDR2 — Мітки</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin:0; background:#000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #map { height:100vh; width:100vw; background:#000; }

    /* Popup shell */
    .leaflet-popup-content-wrapper { background: transparent; box-shadow:none; }
    .leaflet-popup-content { margin: 0; }
    .leaflet-popup-tip { background: rgba(40,28,16,.92); }

    /* Marker (бейдж + іконка як на скріні) */
    .pinWrap{
      position: relative;
      width: 44px; height: 44px;
      transform: translate(-50%, -100%);
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.45));
      user-select: none;
      pointer-events: auto;
    }
    .pinBadge{
      position:absolute;
      top:-10px; left: 50%;
      transform: translateX(-50%);
      padding: 3px 7px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color: #f3e6cf;
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      white-space: nowrap;
    }
    .pinIcon{
      position:absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .pinIcon img{
      width: 26px; height: 26px;
      display:block;
    }

    /* RDR2-like popup card */
    .rdrCard {
      width: 520px;
      border-radius: 26px;
      overflow: hidden;
      background: rgba(45, 30, 18, 0.92);
      color: #f3e6cf;
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      position: relative;
      backdrop-filter: blur(2px);
    }

    .rdrTop { position: relative; height: 290px; background: #1a110a; }
    .rdrImg { width: 100%; height: 100%; object-fit: cover; display: block; filter: saturate(.95) contrast(1.05); }

    .rdrClose{
      position:absolute; top: 12px; right: 12px;
      width: 34px; height: 34px;
      border: 0; border-radius: 10px;
      cursor: pointer;
      color: #fff;
      background: rgba(0,0,0,.35);
      font-size: 20px; line-height: 34px;
    }
    .rdrClose:hover { background: rgba(0,0,0,.55); }

    .navBtn{
      position:absolute; top:50%;
      transform: translateY(-50%);
      width: 48px; height: 48px;
      border: 0; border-radius: 999px;
      cursor: pointer;
      color:#fff;
      background: rgba(0,0,0,.35);
      font-size: 24px; line-height: 48px;
    }
    .navBtn:hover{ background: rgba(0,0,0,.55); }
    .navLeft{ left: 14px; }
    .navRight{ right: 14px; }

    .dotsWrap{
      position:absolute;
      bottom: 12px; left: 50%;
      transform: translateX(-50%);
      display:flex; gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
    }
    .dot{ width: 8px; height: 8px; border-radius:999px; background: rgba(255,255,255,.35); }
    .dot.active{ background: rgba(255,255,255,.9); }

    .rdrBody{
      padding: 14px 16px 18px;
      background: linear-gradient(to bottom, rgba(45,30,18,.92), rgba(30,20,12,.92));
    }

    .titleRow{ display:flex; align-items:flex-end; justify-content:space-between; gap: 10px; margin-bottom: 10px; }
    .titleRow .name{ font-size: 22px; font-weight: 900; letter-spacing: .2px; }
    .titleRow .idPill{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 800;
      color: #ffe6b2;
      white-space: nowrap;
    }

    .metaRow{
      display:flex;
      gap: 10px;
      align-items:center;
      opacity: .95;
      font-weight: 800;
    }
    .pricePill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
    }
    .coin{
      width: 18px; height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.7), rgba(255,255,255,0) 55%),
                  rgba(255, 196, 73, .95);
      box-shadow: 0 0 0 2px rgba(0,0,0,.22) inset;
    }

    @media (max-width: 620px){
      .rdrCard { width: 92vw; }
      .rdrTop { height: 220px; }
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  // =========================
  // PATH FIX (GitHub Pages)
  // =========================
  // Працює для:
  // - https://username.github.io/
  // - https://username.github.io/repo/
  const basePath = location.pathname.endsWith("/")
    ? location.pathname
    : location.pathname.replace(/[^/]+$/, "");

  const MAP_URL   = basePath + "map.jpg";
  const WAGON_URL = basePath + "wagon.png";

  // cache-bust щоб не мучитись з кешем GitHub Pages
  const bust = `?v=${Date.now()}`;

  // =========================
  // STORAGE
  // =========================
  const STORAGE_KEY = "rdr2_pins_v1";

  function loadState() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); }
    catch(e){ return null; }
  }
  function saveState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // =========================
  // DEFAULT PINS (приклад)
  // =========================
  function makeDefaultPins(mapW, mapH){
    return Array.from({length: 15}, (_, i) => {
      const id = i + 1;
      return {
        id,
        name: `Будинок`,
        price: 10000,
        x: Math.round(mapW * (0.55 + (i%5)*0.04)),
        y: Math.round(mapH * (0.25 + Math.floor(i/5)*0.06)),
        photos: [
          "https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1200&q=70",
          "https://images.unsplash.com/photo-1520962917960-0b0d8a8b5b8a?auto=format&fit=crop&w=1200&q=70"
        ]
      };
    });
  }

  // =========================
  // UI helpers
  // =========================
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function renderDots(count, activeIndex) {
    let html = `<div class="dotsWrap">`;
    for (let i=0;i<count;i++){
      html += `<div class="dot ${i===activeIndex ? "active":""}"></div>`;
    }
    html += `</div>`;
    return html;
  }

  function cardHtml(p, photoIndex){
    const photos = (p.photos && p.photos.length) ? p.photos : [WAGON_URL];
    const idx = Math.max(0, Math.min(photoIndex ?? 0, photos.length-1));

    return `
      <div class="rdrCard" data-id="${p.id}" data-idx="${idx}">
        <div class="rdrTop">
          <img class="rdrImg" src="${photos[idx]}" alt="photo">
          <button class="rdrClose" data-action="close">×</button>

          ${photos.length>1 ? `<button class="navBtn navLeft" data-action="prev">‹</button>` : ``}
          ${photos.length>1 ? `<button class="navBtn navRight" data-action="next">›</button>` : ``}
          ${photos.length>1 ? renderDots(photos.length, idx) : ``}
        </div>

        <div class="rdrBody">
          <div class="titleRow">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="idPill">#${p.id}</div>
          </div>

          <div class="metaRow">
            <span class="pricePill"><span class="coin"></span> ${Number(p.price||0).toLocaleString('uk-UA')}</span>
          </div>
        </div>
      </div>
    `;
  }

  function markerHtml(id){
    return `
      <div class="pinWrap">
        <div class="pinBadge">#${id}</div>
        <div class="pinIcon"><img src="${WAGON_URL}" alt=""></div>
      </div>
    `;
  }

  // =========================
  // 1) Спершу зчитуємо розмір map.jpg
  // =========================
  const preload = new Image();
  preload.onload = () => initMap(preload.width, preload.height);
  preload.onerror = () => {
    alert(
      "Не можу завантажити карту.\n\n" +
      "Перевір:\n" +
      "1) файл називається ТОЧНО map.jpg (регістр важливий)\n" +
      "2) лежить поруч з index.html\n" +
      "3) на GitHub Pages він запушений в ту ж папку\n\n" +
      "Спроба завантажити: " + MAP_URL
    );
  };
  preload.src = MAP_URL + bust;

  // =========================
  // INIT MAP
  // =========================
  function initMap(MAP_WIDTH, MAP_HEIGHT){
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomControl: true
    });

    const bounds = [[0,0],[MAP_HEIGHT, MAP_WIDTH]];
    L.imageOverlay(MAP_URL + bust, bounds).addTo(map);

    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    const saved = loadState();
    const pins = saved?.pins ?? makeDefaultPins(MAP_WIDTH, MAP_HEIGHT);

    const markers = new Map();
    const pinById = (id) => pins.find(x => x.id === id);

    function openPinPopup(p, photoIndex = 0){
      const marker = markers.get(p.id);
      if (!marker) return;

      L.popup({ closeButton: false, maxWidth: 540 })
        .setLatLng([p.y, p.x])
        .setContent(cardHtml(p, photoIndex))
        .openOn(map);

      setTimeout(() => bindCard(p.id), 0);
    }

    function bindCard(id){
      const card = document.querySelector(`.rdrCard[data-id="${id}"]`);
      if (!card) return;
      const p = pinById(id);
      if (!p) return;

      const photos = (p.photos && p.photos.length) ? p.photos : [WAGON_URL];
      const getIdx = () => parseInt(card.getAttribute("data-idx"), 10) || 0;

      const closeBtn = card.querySelector('[data-action="close"]');
      if (closeBtn) closeBtn.onclick = () => map.closePopup();

      const prevBtn = card.querySelector('[data-action="prev"]');
      const nextBtn = card.querySelector('[data-action="next"]');

      if (prevBtn) prevBtn.onclick = () => openPinPopup(p, (getIdx() - 1 + photos.length) % photos.length);
      if (nextBtn) nextBtn.onclick = () => openPinPopup(p, (getIdx() + 1) % photos.length);
    }

    // create markers
    pins.forEach(p => {
      const icon = L.divIcon({
        className: "",
        html: markerHtml(p.id),
        iconSize: [44, 44],
        iconAnchor: [0, 0]
      });

      const m = L.marker([p.y, p.x], { icon, draggable: true }).addTo(map);
      markers.set(p.id, m);

      m.on('click', () => openPinPopup(p, 0));

      m.on('dragend', (e) => {
        const ll = e.target.getLatLng();
        p.y = ll.lat;
        p.x = ll.lng;
        saveState({ pins });
      });
    });

    // click to show coords
    map.on('click', (e) => {
      alert(`Координати:\nY(lat): ${Math.round(e.latlng.lat)}\nX(lng): ${Math.round(e.latlng.lng)}`);
    });
  }
</script>
</body>
</html>
