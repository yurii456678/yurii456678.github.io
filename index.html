<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RDR2 ‚Äî –ü–æ–≤–æ–∑–∫–∏ / –ö–æ–Ω–∏–∫–∏</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --bg: #D2B791;
      --ui: rgba(35,24,14,.92);
      --ui2: rgba(45,30,18,.92);
      --text: #f3e6cf;
      --gold: #ffe6b2;

      /* NEW: red accent for locked horses */
      --accent: #ff3d3d;
    }

    html, body{
      height: 100%;
      margin:0;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow: hidden;
    }

    #map{
      position: relative;
      height:100%;
      width:100%;
      background: var(--bg);
    }

    /* –í—ñ–Ω—å—î—Ç–∫–∞ */
    #map::after{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 250;
      background: radial-gradient(circle at 50% 45%,
        rgba(0,0,0,0) 45%,
        rgba(0,0,0,.16) 75%,
        rgba(0,0,0,.30) 100%);
      mix-blend-mode: multiply;
    }

    /* ===== Top Bar Buttons ===== */
    .topBar{
      position: fixed;
      top: calc(10px + env(safe-area-inset-top));
      left: calc(10px + env(safe-area-inset-left));
      right: calc(10px + env(safe-area-inset-right));
      display: flex;
      gap: 10px;
      z-index: 9999;
      pointer-events: none;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn{
      pointer-events: auto;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(35,24,14,.90);
      color: var(--text);
      font-weight: 900;
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(35,24,14,.98); }

    .btnWide{ flex: 1; }
    .btnSmall{ min-width: 118px; }

    @media (max-width: 420px){
      .btn{
        padding: 9px 10px;
        border-radius: 12px;
        font-size: 14px;
        gap: 8px;
      }
      .btnSmall{ min-width: 0; flex: 1; }
      .topBar{ gap: 8px; }
    }

    /* ===== Red blinking dot for locked Horses ===== */
    .horseDot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(255,61,61,.70);
      display: inline-block;
      animation: horseBlink 1s infinite;
      flex: 0 0 auto;
      margin-left: 8px;
    }
    .horseDot.isHidden{ display:none; }
    @keyframes horseBlink{
      0%, 60% { opacity: 1; transform: scale(1); }
      80%     { opacity: .25; transform: scale(.85); }
      100%    { opacity: 1; transform: scale(1); }
    }

    .leaflet-top.leaflet-left {
      top: calc(86px + env(safe-area-inset-top));
      left: calc(10px + env(safe-area-inset-left));
    }
    @media (max-width: 420px){
      .leaflet-top.leaflet-left {
        top: calc(94px + env(safe-area-inset-top));
      }
    }

    /* Popup shell */
    .leaflet-popup-content-wrapper { background: transparent; box-shadow:none; padding:0 !important; }
    .leaflet-popup-content { margin: 0 !important; width: auto !important; }
    .leaflet-popup-tip { background: rgba(40,28,16,.92); }
    .leaflet-popup{ margin-bottom: 12px; }

    /* ===== Marker ===== */
    .pinWrap{
      position: relative;
      width: 44px; height: 44px;
      transform: translate(-50%, -100%);
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.45));
      user-select: none;
      pointer-events: auto;
    }
    .pinBadge{
      position:absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 3px 7px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      white-space: nowrap;
    }
    .pinIcon{
      position:absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .pinIcon img{ width: 26px; height: 26px; display:block; }

    /* ===== Card (–§–Ü–ö–°: —Ü—ñ–Ω–∞ –∑–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º–∞ + –Ω–æ—Ä–º —Å–∫—Ä–æ–ª) ===== */
    .rdrCard{
      width: clamp(320px, 92vw, 560px);
      border-radius: 26px;
      overflow: hidden;
      background: var(--ui2);
      color: var(--text);
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      position: relative;
      backdrop-filter: blur(2px);

      display: flex;
      flex-direction: column;

      max-height: calc(100vh - 130px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
    }
    @media (max-width: 720px){
      .rdrCard{
        border-radius: 22px;
        max-height: calc(100vh - 120px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      }
    }

    .rdrTop{
      position: relative;
      background: #1a110a;
      flex: 0 0 auto;
      aspect-ratio: var(--ar, 16 / 9);
      border-top-left-radius: 26px;
      border-top-right-radius: 26px;
      overflow: hidden;
    }
    @media (max-width: 720px){
      .rdrTop{
        border-top-left-radius: 22px;
        border-top-right-radius: 22px;
      }
    }

    .rdrImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
      filter: saturate(.95) contrast(1.05);
      background: rgba(0,0,0,.15);
    }

    .rdrClose{
      position:absolute; top: 12px; right: 12px;
      width: 34px; height: 34px;
      border: 0; border-radius: 10px;
      cursor: pointer;
      color: #fff;
      background: rgba(0,0,0,.35);
      font-size: 20px; line-height: 34px;
      z-index: 10;
      -webkit-tap-highlight-color: transparent;
    }
    .rdrClose:hover { background: rgba(0,0,0,.55); }

    .navBtn{
      position:absolute; top:50%;
      transform: translateY(-50%);
      width: 48px; height: 48px;
      border: 0; border-radius: 999px;
      cursor: pointer;
      color:#fff;
      background: rgba(0,0,0,.35);
      font-size: 24px; line-height: 48px;
      z-index: 10;
      -webkit-tap-highlight-color: transparent;
    }
    .navBtn:hover{ background: rgba(0,0,0,.55); }
    .navLeft{ left: 14px; }
    .navRight{ right: 14px; }

    .dotsWrap{
      position:absolute;
      bottom: 12px; left: 50%;
      transform: translateX(-50%);
      display:flex; gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      z-index: 10;
    }
    .dot{ width: 8px; height: 8px; border-radius:999px; background: rgba(255,255,255,.35); }
    .dot.active{ background: rgba(255,255,255,.9); }

    .rdrBody{
      padding: 14px 16px 16px;
      background: linear-gradient(to bottom, rgba(45,30,18,.92), rgba(30,20,12,.92));

      flex: 1 1 auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;

      max-height: none;
    }

    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .titleRow .name{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .titleRow .idPill{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
      color: var(--gold);
      white-space: nowrap;
    }

    .horseNameBig{
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--gold);
      margin-top: 2px;
      margin-bottom: 8px;
      line-height: 1.15;
      text-shadow: 0 10px 22px rgba(0,0,0,.28);
    }
    .horseDesc{
      opacity: .92;
      line-height: 1.32;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px 10px;
      border-radius: 14px;
      margin-bottom: 12px;
      font-weight: 800;
      font-size: 13px;
    }

    .statsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
    }
    .stat{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .stat .label{ font-size: 12px; opacity: .88; margin-bottom: 6px; }
    .stat .value{ font-size: 18px; font-weight: 900; letter-spacing: .2px; }

    .priceRow{
      display:flex;
      align-items:baseline;
      justify-content:flex-start;
      gap: 10px;

      position: sticky;
      bottom: 0;

      padding-top: 12px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      margin-top: 10px;

      border-top: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to top, rgba(30,20,12,.98), rgba(30,20,12,.60));
      backdrop-filter: blur(2px);
    }
    .priceLabel{
      font-size: 14px;
      opacity: .90;
      font-weight: 900;
      color: var(--text);
    }
    .priceValue{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: .4px;
      color: var(--gold);
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    /* ===== Group picker ===== */
    .pickRow{
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .pickTitle{
      font-size: 12px;
      opacity: .85;
      font-weight: 900;
      margin-bottom: 8px;
    }
    .pickBtns{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pickBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pickBtn.active{
      background: rgba(255,255,255,.18);
      color: var(--gold);
    }

    /* ===== Left Drawer ===== */
    .drawer{
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      width: min(420px, 92vw);
      background: rgba(20,14,8,.92);
      backdrop-filter: blur(6px);
      border-right: 1px solid rgba(255,255,255,.10);
      transform: translateX(-105%);
      transition: transform .22s ease;
      z-index: 9998;
      display:flex;
      flex-direction: column;
      padding-top: calc(12px + env(safe-area-inset-top));
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .drawer.open{ transform: translateX(0); }

    .drawerHeader{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      color: var(--text);
    }
    .drawerTitle{
      font-weight: 1000;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .drawerClose{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .drawerList{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .wagonRow{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .wagonRow:hover{ background: rgba(255,255,255,.09); }

    .wagonLeft{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .wagonMain{
      font-weight: 1000;
      font-size: 18px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .wagonSub{
      opacity: .85;
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pricePill{
      flex: 0 0 auto;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--gold);
      font-weight: 1000;
      font-size: 18px;
    }

    .scrim{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.25);
      z-index: 9997;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .scrim.show{
      opacity: 1;
      pointer-events: auto;
    }

    @media (max-width: 720px){
      .leaflet-popup{ margin-top: calc(10px + env(safe-area-inset-top)); }
    }

    /* ===== Coords floating button ===== */
    .fab{
      position: fixed;
      right: calc(12px + env(safe-area-inset-right));
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 9999;
      pointer-events: none;
    }
    .fab .btn{
      pointer-events: auto;
      border-radius: 999px;
      padding: 12px 14px;
      min-width: 0;
    }

    /* ===== Access Modal (–ö–æ–Ω–∏–∫–∏) ===== */
    .accessModal{
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      overflow: hidden;
    }
    .accessBox{
      width: min(560px, 92vw);
      max-height: min(78vh, 620px);
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
      background: rgba(35,24,14,.96);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      color: #f3e6cf;
      padding: 16px;
    }
    .accessHead{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .accessTitle{
      font-weight: 1000;
      font-size: 18px;
    }
    .accessX{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: #f3e6cf;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor: pointer;
      line-height: 1;
    }
    .accessText{
      margin-top: 10px;
      opacity: .95;
      line-height: 1.35;
    }
    .accessEmail{
      display: inline-block;
      margin-left: 6px;
      font-weight: 1000;
      color: #ffe6b2;
      word-break: break-word;
    }
    .accessLabel{
      display: block;
      margin-top: 12px;
      font-weight: 900;
      font-size: 13px;
      opacity: .9;
      text-align: center;
    }
    .accessInput{
      width: 220px;
      max-width: 100%;
      margin: 8px auto 0;
      display: block;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: #f3e6cf;
      outline: none;
      font-weight: 900;
      letter-spacing: .18em;
      text-transform: uppercase;
      text-align: center;
    }
    .accessError{
      margin-top: 10px;
      color: #ffcf9a;
      font-weight: 900;
      display: none;
      text-align: center;
    }
    .accessBtns{
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .accessBtnPrimary{
      flex: 1;
      min-width: 180px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.12);
      color: #ffe6b2;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 1000;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .accessBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: #f3e6cf;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 1000;
      cursor: pointer;
    }
    .spinner{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.28);
      border-top-color: rgba(255,255,255,.9);
      display:inline-block;
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
  </style>
</head>

<body>
  <!-- –≤—Å–µ —â–æ —Ç—Ä–µ–±–∞ "—Ö–æ–≤–∞—Ç–∏" –≤—ñ–¥ a11y –ø—ñ–¥ —á–∞—Å –º–æ–¥–∞–ª–∫–∏ -->
  <div id="appRoot">
    <!-- LEFT DRAWER -->
    <div class="scrim" id="scrim"></div>
    <aside class="drawer" id="drawer" aria-hidden="true">
      <div class="drawerHeader">
        <div class="drawerTitle" id="drawerTitle">–°–ø–∏—Å–æ–∫</div>
        <button class="drawerClose" id="drawerClose" type="button">√ó</button>
      </div>
      <div class="drawerList" id="drawerList"></div>
    </aside>

    <!-- TOP BAR -->
    <div class="topBar">
      <button class="btn btnSmall" id="listBtn" type="button">‚ò∞ –°–ø–∏—Å–æ–∫</button>

      <button class="btn btnSmall" id="toggleBtn" type="button">
        üêé –ö–æ–Ω–∏–∫–∏
        <span class="horseDot" id="horseDot" aria-hidden="true"></span>
      </button>

      <button class="btn btnSmall" id="reloadBtn" type="button">‚ü≥ –û–Ω–æ–≤–∏—Ç–∏</button>
    </div>

    <!-- FLOATING COORDS BUTTON -->
    <div class="fab">
      <button class="btn" id="coordsBtn" type="button">üìç –í–∏–º–∫</button>
    </div>

    <div id="map"></div>
  </div>

  <!-- ACCESS MODAL -->
  <div class="accessModal" id="accessModal" aria-hidden="true">
    <div class="accessBox" role="dialog" aria-modal="true" aria-labelledby="accessTitle" aria-describedby="accessDesc">
      <div class="accessHead">
        <div class="accessTitle" id="accessTitle">–î–æ—Å—Ç—É–ø –¥–æ ‚Äú–ö–æ–Ω–∏–∫—ñ–≤‚Äù</div>
        <button class="accessX" id="accessClose" type="button" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
      </div>

      <div class="accessText" id="accessDesc">
        –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ —Ä–æ–∑–¥—ñ–ª—É <b>‚Äú–ö–æ–Ω–∏–∫–∏‚Äù</b> –ø–æ—Ç—Ä—ñ–±–Ω–æ <b>100$</b>.<br>
        –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –Ω–∞ –ø–æ—à—Ç—É:
        <span class="accessEmail">–ü–û–®–¢–ê_–¢–£–¢</span>
      </div>

      <label class="accessLabel" for="accessCode">–ö–æ–¥</label>
      <input class="accessInput" id="accessCode" autocomplete="off" inputmode="latin" />

      <div class="accessError" id="accessError" role="status" aria-live="polite">–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥.</div>

      <div class="accessBtns">
        <button class="accessBtnPrimary" id="accessSubmit" type="button">
          <span id="accessSpin" class="spinner" aria-hidden="true" style="display:none"></span>
          <span id="accessSubmitText">–í—ñ–¥–∫—Ä–∏—Ç–∏</span>
        </button>
        <button class="accessBtn" id="accessCancel" type="button">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <script>
    // ===== PATH (GitHub Pages safe) =====
    const basePath = location.pathname.endsWith("/")
      ? location.pathname
      : location.pathname.replace(/[^/]+$/, "");
    const bust = `?v=${Date.now()}`;

    const MAP_URL   = basePath + "map.jpg"   + bust;
    const WAGON_URL = basePath + "wagon.png" + bust;
    const HORSE_URL = basePath + "horse.png" + bust;

    // ===== WORKER (KV codes) =====
    const WORKER_BASE = "https://shiny-mud-0b7d.yurromanow.workers.dev";
    const ENDPOINT_VERIFY = "/verify";
    const ENDPOINT_STATUS = "/status";
    const HORSES_TOKEN_KEY = "horses_access_token_v1";

    function getToken(){
      try { return localStorage.getItem(HORSES_TOKEN_KEY) || ""; } catch { return ""; }
    }
    function setToken(t){
      try{
        if (!t) localStorage.removeItem(HORSES_TOKEN_KEY);
        else localStorage.setItem(HORSES_TOKEN_KEY, t);
      } catch {}
    }

    async function workerFetch(path, opts = {}){
      const url = WORKER_BASE + path;
      const headers = new Headers(opts.headers || {});
      headers.set("Accept", "application/json");

      const token = getToken();
      if (token) headers.set("Authorization", "Bearer " + token);

      const res = await fetch(url, {
        ...opts,
        headers,
        cache: "no-store",
        credentials: "omit"
      });

      let data = null;
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("application/json")) data = await res.json().catch(() => null);
      else {
        const text = await res.text().catch(() => "");
        data = text ? { raw: text } : null;
      }
      return { res, data };
    }

    async function verifyWithWorker(code){
      const { res, data } = await workerFetch(ENDPOINT_VERIFY, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code })
      });

      if (!res.ok){
        return { ok:false, error: (data && (data.error || data.message)) || ("–ü–æ–º–∏–ª–∫–∞ Worker ("+res.status+")") };
      }

      if (data && data.ok === true){
        return { ok:true, token: data.token || "" };
      }

      if (data && (data.valid === true || data.allowed === true)){
        return { ok:true, token: data.token || "" };
      }

      return { ok:false, error: (data && (data.error || data.message)) || "–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥" };
    }

    async function checkStatusWithWorker(){
      try{
        const { res, data } = await workerFetch(ENDPOINT_STATUS, { method: "GET" });
        if (!res.ok) return { ok:false };

        if (data && (data.ok === true || data.valid === true || data.allowed === true)) return { ok:true };
        if (data && typeof data.raw === "string" && data.raw.toLowerCase().includes("ok")) return { ok:true };

        return { ok:false };
      } catch {
        return { ok:false };
      }
    }

    function normalizeCode(s){
      return String(s || "").trim().toUpperCase().replace(/\s+/g, "");
    }

    // ===== DATA (WAGONS) =====
    function cityById(id){
      if (id === 1) return "Saint Denis";
      if (id === 2) return "Van Horn";
      if (id === 3) return "Dewberry Creerk";
      if ([4,5,6,7].includes(id)) return "Valentine";
      if ([8,9].includes(id)) return "Gorge";
      if ([10,11,12].includes(id)) return "Strawberry";
      if (id === 13) return "Blackwater";
      if ([14,15].includes(id)) return "Tumbleweed";
      return "";
    }

    const WAGONS_DATA = [
      { id: 1,  title: "–í–æ–∑–∏–∫", price: 3100, deliveriesToBuy: 20,  passengers: 2,  slots: 0,  kg: 0,   photos: ["W1.jpg"]  },
      { id: 2,  title: "–í–æ–∑–∏–∫", price: 6000, deliveriesToBuy: 80,  passengers: 8,  slots: 30, kg: 50,  photos: ["W2.jpg"]  },
      { id: 3,  title: "–í–æ–∑–∏–∫", price: 3850, deliveriesToBuy: 30,  passengers: 3,  slots: 40, kg: 100, photos: ["W3.jpg"]  },
      { id: 4,  title: "–í–æ–∑–∏–∫", price: 3050, deliveriesToBuy: 20,  passengers: 2,  slots: 0,  kg: 0,   photos: ["W4.jpg"]  },
      { id: 5,  title: "–í–æ–∑–∏–∫", price: 3350, deliveriesToBuy: 20,  passengers: 2,  slots: 40, kg: 175, photos: ["W5.jpg"]  },
      { id: 6,  title: "–í–æ–∑–∏–∫", price: 3250, deliveriesToBuy: 20,  passengers: 2,  slots: 30, kg: 125, photos: ["W6.jpg"]  },
      { id: 7,  title: "–í–æ–∑–∏–∫", price: 2800, deliveriesToBuy: 15,  passengers: 1,  slots: 30, kg: 100, photos: ["W7.jpg"]  },
      { id: 8,  title: "–í–æ–∑–∏–∫", price: 2750, deliveriesToBuy: 10,  passengers: 1,  slots: 30, kg: 50,  photos: ["W8.jpg"]  },
      { id: 9,  title: "–í–æ–∑–∏–∫", price: 3000, deliveriesToBuy: 20,  passengers: 2,  slots: 0,  kg: 0,   photos: ["W9.jpg"]  },
      { id: 10, title: "–í–æ–∑–∏–∫", price: 5250, deliveriesToBuy: 60,  passengers: 6,  slots: 30, kg: 100, photos: ["W10.jpg"] },
      { id: 11, title: "–í–æ–∑–∏–∫", price: 8000, deliveriesToBuy: 120, passengers: 12, slots: 30, kg: 50,  photos: ["W11.jpg"] },
      { id: 12, title: "–í–æ–∑–∏–∫", price: 7250, deliveriesToBuy: 100, passengers: 10, slots: 30, kg: 50,  photos: ["W12.jpg"] },
      { id: 13, title: "–í–æ–∑–∏–∫", price: 2500, deliveriesToBuy: 5,   passengers: 1,  slots: 30, kg: 50,  photos: ["W13.jpg"] },
      { id: 14, title: "–í–æ–∑–∏–∫", price: 6500, deliveriesToBuy: 80,  passengers: 6,  slots: 50, kg: 350, photos: ["W14.jpg"] },
      { id: 15, title: "–í–æ–∑–∏–∫", price: 8250, deliveriesToBuy: 120, passengers: 12, slots: 30, kg: 150, photos: ["W15.jpg"] },
    ].map(w => ({ ...w, city: cityById(w.id) }));

    // ===== DATA (HORSES) =====
    const BREED_DESC = {
      "Criollo": "–ú–∞–ª–∏–π —ñ —Ä–æ–∑—É–º–Ω–∏–π –º—É–ª—å—Ç–∏–∫–ª–∞—Å: —à–≤–∏–¥–∫–∏–π, –≤–∏—Ç—Ä–∏–≤–∞–ª–∏–π, –¥—É–∂–µ —Å–ø—Ä–∏—Ç–Ω–∏–π.",
      "Breton": "–ú—ñ—Ü–Ω–∏–π —ñ –º‚Äô—è–∑–∏—Å—Ç–∏–π –º—É–ª—å—Ç–∏–∫–ª–∞—Å: –¥–æ–±—Ä–µ —Ç—Ä–∏–º–∞—î —Ç–µ–º–ø —É –±–æ—é —Ç–∞ –≤ –ø–æ–≥–æ–Ω—è—Ö.",
      "Hungarian Halfbred": "–í–µ–ª–∏–∫–∏–π –±–æ–π–æ–≤–∏–π –∫—ñ–Ω—å: –≤–∏—Å–æ–∫–µ –∑–¥–æ—Ä–æ–≤‚Äô—è —Ç–∞ –≤–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å, —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π –ø—ñ–¥ –≤–æ–≥–Ω–µ–º.",
      "Turkoman": "–°—É–º—ñ—à —Å–∫–∞–∫—É–Ω–∞ –π –±–æ–π–æ–≤–æ–≥–æ: —à–≤–∏–¥–∫–∏–π, –≤–∏—Ç—Ä–∏–≤–∞–ª–∏–π, —Å—Ç—Ä—É–Ω–∫–∏–π —Ç–∞ agile.",
      "Morgan": "–ù–µ–≤–µ–ª–∏–∫–∏–π –≤–µ—Ä—Ö–æ–≤–∏–π: –µ–ª–µ–≥–∞–Ω—Ç–Ω–∞ —Ö–æ–¥–∞, –∫–æ–º—Ñ–æ—Ä—Ç–Ω–∏–π –¥–ª—è —â–æ–¥–µ–Ω–Ω–æ—ó —ó–∑–¥–∏.",
      "Tennessee Walker": "–ì–ª–∞–¥–∫–∏–π —Ö—ñ–¥ —ñ –µ–ª–µ–≥–∞–Ω—Ç–Ω–∏–π –∫–æ—Ä–ø—É—Å: –∑—Ä—É—á–Ω–∏–π –¥–ª—è –¥–æ–≤–≥–∏—Ö –ø–æ–¥–æ—Ä–æ–∂–µ–π.",
      "Kladruber": "–†—ñ–¥–∫—ñ—Å–Ω–∏–π —ñ —Å–∏–ª—å–Ω–∏–π: —Å–ø–æ–∫—ñ–π–Ω–∏–π, ‚Äú—Å—Ç–µ–¥–¥—ñ‚Äù, —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –ø—ñ–¥ —Ä—ñ–∑–Ω—ñ –∑–∞–¥–∞—á—ñ.",
      "Andalusian": "–ö–æ–º–ø–∞–∫—Ç–Ω–∏–π –±–æ–π–æ–≤–∏–π: –º—ñ—Ü–Ω–∏–π, –∑ —Ö–æ—Ä–æ—à–∏–º–∏ –∑–¥–æ—Ä–æ–≤‚Äô—è–º —ñ —Å—Ç–∞–º—ñ–Ω–æ—é.",
      "Ardennes": "–í–∞–∂–∫–∏–π –±–æ–π–æ–≤–∏–π: –¥—É–∂–µ –º—ñ—Ü–Ω–∏–π, —Å–º—ñ–ª–∏–≤–∏–π —ñ –≤–∏—Ç—Ä–∏–≤–∞–ª–∏–π —É —Å—É—Ç–∏—á–∫–∞—Ö.",
      "–ë—ñ–¥–æ—Å—è": "–ö–ª—è—á–∞-–ª–µ–≥–µ–Ω–¥–∞: —ó–¥–µ, —Å—Ç—Ä–∞–∂–¥–∞—î —ñ —Ä–æ–±–∏—Ç—å –≤–∏–≥–ª—è–¥, —â–æ —Ç–∞–∫ —ñ —Ç—Ä–µ–±–∞."
    };

    const HORSES_DATA = [
      { id: 1,  breed: "Criollo", coat: "Grillo blue roan overo", price: 1050 },
      { id: 2,  breed: "Criollo", coat: "Grillo blue roan overo", price: 900  },
      { id: 3,  breed: "Criollo", coat: "Grullo dun",            price: 850  },
      { id: 4,  breed: "Criollo", coat: "Grillo marble sabino",  price: 800  },
      { id: 5,  breed: "Criollo", coat: "Grillo sorrel overo",   price: 1000 },
      { id: 6,  breed: "Criollo", coat: "Grillo bay brindle",    price: 950  },

      { id: 7,  breed: "Breton", coat: "Sorrel",              price: 2350 },
      { id: 8,  breed: "Breton", coat: "Steel grey",          price: 2400 },
      { id: 9,  breed: "Breton", coat: "Grullo dun",          price: 2300 },
      { id: 10, breed: "Breton", coat: "Mealy dapple bay",    price: 2450 },
      { id: 11, breed: "Breton", coat: "Seal brown",          price: 2500 },
      { id: 12, breed: "Breton", coat: "Red roan",            price: 2250 },

      { id: 13, breed: "Hungarian Halfbred", coat: "Piebald tobiano",     price: 1800 },
      { id: 14, breed: "Hungarian Halfbred", coat: "Liver chestnut",      price: 1850 },
      { id: 15, breed: "Hungarian Halfbred", coat: "Flaxen chestnut",     price: 1750 },
      { id: 16, breed: "Hungarian Halfbred", coat: "Dark dapple grey",    price: 1700 },
      { id: 17, breed: "Turkoman", coat: "Grey",     price: 1950 },
      { id: 18, breed: "Turkoman", coat: "Gold",     price: 2200 },
      { id: 19, breed: "Turkoman", coat: "Dark bay", price: 2050 },
      { id: 20, breed: "Turkoman", coat: "Chestnut", price: 2150 },
      { id: 21, breed: "Turkoman", coat: "Black",    price: 2100 },
      { id: 22, breed: "Turkoman", coat: "Silver",   price: 2000 },
      { id: 23, breed: "Turkoman", coat: "Perlino",  price: 1900 },

      { id: 24, breed: "–ü–µ—Ä—à–∞", coat: "–ë—ñ–¥–æ—Å—è",        price: 30 },
      { id: 25, breed: "Morgan", coat: "Palomino",        price: 150 },
      { id: 26, breed: "Morgan", coat: "Liver chestnut",  price: 175 },
      { id: 27, breed: "Morgan", coat: "Flaxen chestnut", price: 150 },
      { id: 28, breed: "Morgan", coat: "Bay",             price: 145 },
      { id: 29, breed: "Morgan", coat: "Bay roan",        price: 125 },

      { id: 30, breed: "Tennessee Walker", coat: "Black rabicano",   price: 450 },
      { id: 31, breed: "Tennessee Walker", coat: "Chestnut",         price: 400 },
      { id: 32, breed: "Tennessee Walker", coat: "Dapple bay",       price: 425 },
      { id: 33, breed: "Tennessee Walker", coat: "Flaxen roan",      price: 375 },
      { id: 34, breed: "Tennessee Walker", coat: "Gold palomino",    price: 425 },
      { id: 35, breed: "Tennessee Walker", coat: "Mahogany",         price: 440 },
      { id: 36, breed: "Tennessee Walker", coat: "Red roan",         price: 380 },

      { id: 37, breed: "Kladruber", coat: "Black",             price: 1650 },
      { id: 38, breed: "Kladruber", coat: "Cremello",          price: 1400 },
      { id: 39, breed: "Kladruber", coat: "Dapple rose grey",  price: 1500 },
      { id: 40, breed: "Kladruber", coat: "Grey",              price: 1450 },
      { id: 41, breed: "Kladruber", coat: "Silver",            price: 1550 },
      { id: 42, breed: "Kladruber", coat: "White",             price: 1600 },

      { id: 43, breed: "Andalusian", coat: "Dark bay",       price: 1200 },
      { id: 44, breed: "Andalusian", coat: "Perlino",        price: 1150 },
      { id: 45, breed: "Andalusian", coat: "Rose grey",      price: 1100 },
      { id: 46, breed: "Ardennes",   coat: "Bay roan",       price: 1300 },
      { id: 47, breed: "Ardennes",   coat: "Iron grey",      price: 1350 },
      { id: 48, breed: "Ardennes",   coat: "Strawberry roan",price: 1250 },
    ].map(h => ({
      ...h,
      title: `–ö—ñ–Ω—å - ${h.id}`,
      fullName: `${h.breed} ${h.coat}`.trim(),
      desc: BREED_DESC[h.breed] || "–ö–ª—è—á–∞ –∑ –≤–µ–ª–∏–∫–∏–º —Å–µ—Ä—Ü–µ–º —ñ –Ω—É–ª—å–æ–≤–∏–º–∏ –∞–º–±—ñ—Ü—ñ—è–º–∏.",
      photos: [`H${h.id}.jpg`]
    }));

    const HORSE_GROUPS = [
      { ids: [1,2,3,4,5,6],               x: 1965, y: 1183 },
      { ids: [7,8,9,10,11,12],            x: 1132, y: 1493 },
      { ids: [13,14,15,16,17,18,19,20,21,22,23], x: 319,  y: 436  },
      { ids: [24,25,26,27,28,29,30,31,32,33,34,35,36],     x: 1311, y: 1180 },
      { ids: [37,38,39,40,41,42],         x: 1038, y: 920  },
      { ids: [43,44,45,46,47,48],         x: 1221, y: 763  },
    ];

    // –ì–†–£–ü–ò –ø–æ–≤–æ–∑–æ–∫
    const GROUPS = [
      { ids: [1],        x: 1874, y: 747  },
      { ids: [2],        x: 1969, y: 1182 },
      { ids: [3],        x: 1621, y: 989  },
      { ids: [4,5,6,7],  x: 1315, y: 1181 },
      { ids: [8,9],      x: 1129, y: 1491 },
      { ids: [10,11,12], x: 1046, y: 922  },
      { ids: [13],       x: 1222, y: 763  },
      { ids: [14,15],    x: 318,  y: 443  },
    ];

    // ===== HELPERS =====
    const num = (n) => (Number.isFinite(Number(n)) ? Number(n) : 0);
    const fmtInt = (n) => String(Math.round(num(n)));
    function fmtPriceDot(n){
      const s = Math.round(num(n)).toString();
      return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    const esc = (s) => String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");

    function resolveUrl(u){
      const s = String(u || "").trim();
      if (!s) return "";
      if (s.startsWith("http://") || s.startsWith("https://") || s.startsWith("data:")) return s;
      return basePath + s + bust;
    }

    function renderDots(count, activeIndex){
      let html = `<div class="dotsWrap">`;
      for (let i=0;i<count;i++) html += `<div class="dot ${i===activeIndex ? "active":""}"></div>`;
      html += `</div>`;
      return html;
    }

    function groupLabel(ids){
      if (ids.length === 1) return `#${ids[0]}`;
      const min = Math.min(...ids);
      const max = Math.max(...ids);
      return `#${min}-${max}`;
    }

    function markerHtml(label, iconUrl){
      return `
        <div class="pinWrap">
          <div class="pinBadge">${label}</div>
          <div class="pinIcon"><img src="${iconUrl}" alt=""></div>
        </div>
      `;
    }

    function groupHeaderHtml(ids, activeId, title = "–í–∏–±–µ—Ä–∏:"){
      if (!ids || ids.length <= 1) return "";
      const buttons = ids.map(id => {
        const active = id === activeId ? "active" : "";
        return `<button class="pickBtn ${active}" data-pick="${id}" type="button">#${id}</button>`;
      }).join("");

      return `
        <div class="pickRow">
          <div class="pickTitle">${esc(title)}</div>
          <div class="pickBtns">${buttons}</div>
        </div>
      `;
    }

    function cardHtml(w, photoIndex){
      const rawPhotos = (w.photos && w.photos.length) ? w.photos : ["wagon.png"];
      const photos = rawPhotos.map(resolveUrl).filter(Boolean);
      const idx = Math.max(0, Math.min(photoIndex ?? 0, photos.length-1));
      const src = photos[idx] || WAGON_URL;

      return `
        <div class="rdrCard" data-id="${w.id}" data-idx="${idx}">
          <div class="rdrTop">
            <img class="rdrImg" src="${src}" alt="photo">
            <button class="rdrClose" data-action="close" type="button">√ó</button>
            ${photos.length>1 ? `<button class="navBtn navLeft" data-action="prev" type="button">‚Äπ</button>` : ``}
            ${photos.length>1 ? `<button class="navBtn navRight" data-action="next" type="button">‚Ä∫</button>` : ``}
            ${photos.length>1 ? renderDots(photos.length, idx) : ``}
          </div>
          <div class="rdrBody">
            <div class="titleRow">
              <div class="name">${esc(w.title || "–í–æ–∑–∏–∫")}</div>
              <div class="idPill">#${w.id}</div>
            </div>
            <div class="statsGrid">
              <div class="stat"><div class="label">–ü–∞—Å–∞–∂–∏—Ä—ñ–≤</div><div class="value">${fmtInt(w.passengers)}</div></div>
              <div class="stat"><div class="label">–°–ª–æ—Ç–∏</div><div class="value">${fmtInt(w.slots)}</div></div>
              <div class="stat"><div class="label">–ö–≥</div><div class="value">${fmtInt(w.kg)}</div></div>
              <div class="stat"><div class="label">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Å—Ç–∞–≤–æ–∫ –¥–ª—è –∫—É–ø—ñ–≤–ª—ñ</div><div class="value">${fmtInt(w.deliveriesToBuy)}</div></div>
            </div>
            <div class="priceRow">
              <span class="priceLabel">–¶—ñ–Ω–∞</span>
              <span class="priceValue">${fmtPriceDot(w.price)} $</span>
            </div>
          </div>
        </div>
      `;
    }

    function groupCardHtml(wagons, groupIds, activeId, photoIndex = 0){
      const w = wagons.find(x => x.id === activeId);
      if (!w) return "";
      const raw = cardHtml(w, photoIndex);
      return raw.replace(`<div class="rdrBody">`, `<div class="rdrBody">${groupHeaderHtml(groupIds, activeId, "–í–∏–±–µ—Ä–∏ –ø–æ–≤–æ–∑–∫—É:")}`);
    }

    function horseCardHtml(h, photoIndex){
      const rawPhotos = (h.photos && h.photos.length) ? h.photos : ["horse.png"];
      const photos = rawPhotos.map(resolveUrl).filter(Boolean);
      const idx = Math.max(0, Math.min(photoIndex ?? 0, photos.length-1));
      const src = photos[idx] || HORSE_URL;

      return `
        <div class="rdrCard" data-hid="${h.id}" data-idx="${idx}">
          <div class="rdrTop">
            <img class="rdrImg" src="${src}" alt="photo">
            <button class="rdrClose" data-action="close" type="button">√ó</button>
            ${photos.length>1 ? `<button class="navBtn navLeft" data-action="prev" type="button">‚Äπ</button>` : ``}
            ${photos.length>1 ? `<button class="navBtn navRight" data-action="next" type="button">‚Ä∫</button>` : ``}
            ${photos.length>1 ? renderDots(photos.length, idx) : ``}
          </div>
          <div class="rdrBody">
            <div class="titleRow">
              <div class="name">${esc(h.title || `–ö—ñ–Ω—å - ${h.id}`)}</div>
              <div class="idPill">#${h.id}</div>
            </div>
            <div class="horseNameBig">${esc((h.fullName || "").toUpperCase())}</div>
            <div class="horseDesc">${esc(h.desc || "")}</div>
            <div class="priceRow">
              <span class="priceLabel">–¶—ñ–Ω–∞</span>
              <span class="priceValue">${fmtPriceDot(h.price)} $</span>
            </div>
          </div>
        </div>
      `;
    }

    function horseGroupCardHtml(horses, groupIds, activeId, photoIndex = 0){
      const h = horses.find(x => x.id === activeId);
      if (!h) return "";
      const raw = horseCardHtml(h, photoIndex);
      return raw.replace(`<div class="rdrBody">`, `<div class="rdrBody">${groupHeaderHtml(groupIds, activeId, "–í–∏–±–µ—Ä–∏ –∫–æ–Ω–∏–∫–∞:")}`);
    }

    // ===== Drawer =====
    const appRoot = document.getElementById("appRoot");
    const drawer = document.getElementById("drawer");
    const scrim  = document.getElementById("scrim");
    const drawerList = document.getElementById("drawerList");
    const drawerTitleEl = document.getElementById("drawerTitle");

    function openDrawer(){
      drawer.classList.add("open");
      scrim.classList.add("show");
      drawer.setAttribute("aria-hidden", "false");
    }
    function closeDrawer(){
      drawer.classList.remove("open");
      scrim.classList.remove("show");
      drawer.setAttribute("aria-hidden", "true");
    }

    document.getElementById("listBtn").onclick = openDrawer;
    document.getElementById("drawerClose").onclick = closeDrawer;
    scrim.onclick = closeDrawer;

    // ===== Buttons =====
    document.getElementById("reloadBtn").onclick = () => location.reload();

    let coordsEnabled = false;
    const coordsBtn = document.getElementById("coordsBtn");
    function updateCoordsBtn(){
      coordsBtn.textContent = coordsEnabled ? "üìç –£–≤—ñ–º–∫" : "üìç –í–∏–º–∫";
    }
    coordsBtn.onclick = () => {
      coordsEnabled = !coordsEnabled;
      updateCoordsBtn();
    };
    updateCoordsBtn();

    // ===== PRELOAD MAP =====
    const preload = new Image();
    preload.onload = () => initMap(preload.width, preload.height);
    preload.onerror = () => alert("–ù–µ –º–æ–∂—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ map.jpg. –ü–µ—Ä–µ–≤—ñ—Ä —Ñ–∞–π–ª map.jpg –ø–æ—Ä—É—á –∑ index.html");
    preload.src = MAP_URL;

    function initMap(MAP_WIDTH, MAP_HEIGHT){
      const map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -2,
        maxZoom: 2,
        zoomControl: true,
        zoomAnimation: false,
        markerZoomAnimation: false,
        fadeAnimation: false,
        tap: true
      });

      const bounds = [[0,0],[MAP_HEIGHT, MAP_WIDTH]];
      L.imageOverlay(MAP_URL, bounds).addTo(map);
      map.fitBounds(bounds);
      map.setMaxBounds(bounds);

      const wagonsLayer = L.layerGroup().addTo(map);
      const horsesLayer = L.layerGroup();
      let currentMode = "wagons";

      const wagonById = new Map(WAGONS_DATA.map(w => [w.id, w]));
      const groupByWagonId = new Map();
      GROUPS.forEach((g, idx) => g.ids.forEach(id => groupByWagonId.set(id, idx)));

      const horseById = new Map(HORSES_DATA.map(h => [h.id, h]));
      const groupByHorseId = new Map();
      HORSE_GROUPS.forEach((g, idx) => g.ids.forEach(id => groupByHorseId.set(id, idx)));

      const markersByWagonGroupIndex = new Map();
      const markersByHorseGroupIndex = new Map();

      // ===== WAGONS (group popups) =====
      function openWagonGroupPopup(groupIndex, activeId, photoIndex = 0){
        const g = GROUPS[groupIndex];
        const marker = markersByWagonGroupIndex.get(groupIndex);
        if (!g || !marker) return;

        marker.bindPopup(groupCardHtml(WAGONS_DATA, g.ids, activeId, photoIndex), {
          closeButton: false,
          maxWidth: 600,
          autoPan: true,
          keepInView: true,
          autoPanPaddingTopLeft: [14, 110],
          autoPanPaddingBottomRight: [14, 14],
          className: "rdrPopup"
        }).openPopup();

        setTimeout(() => bindWagonGroupPopup(activeId, marker), 0);
      }

      function bindWagonGroupPopup(activeId, marker){
        const root = document.querySelector(`.rdrCard[data-id="${activeId}"]`);
        if (!root) return;

        L.DomEvent.disableClickPropagation(root);
        L.DomEvent.disableScrollPropagation(root);

        const w = wagonById.get(activeId);
        const photos = ((w?.photos && w.photos.length) ? w.photos : ["wagon.png"]).map(resolveUrl).filter(Boolean);
        const getIdx = () => parseInt(root.getAttribute("data-idx"), 10) || 0;

        const imgEl = root.querySelector(".rdrImg");
        if (imgEl) imgEl.onerror = () => { imgEl.src = WAGON_URL; };

        const closeBtn = root.querySelector('[data-action="close"]');
        if (closeBtn) closeBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); marker.closePopup(); };

        const prevBtn = root.querySelector('[data-action="prev"]');
        const nextBtn = root.querySelector('[data-action="next"]');

        if (prevBtn && photos.length > 1){
          prevBtn.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            const idx = (getIdx() - 1 + photos.length) % photos.length;
            const groupIndex = groupByWagonId.get(activeId);
            openWagonGroupPopup(groupIndex, activeId, idx);
          };
        }

        if (nextBtn && photos.length > 1){
          nextBtn.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            const idx = (getIdx() + 1) % photos.length;
            const groupIndex = groupByWagonId.get(activeId);
            openWagonGroupPopup(groupIndex, activeId, idx);
          };
        }

        root.querySelectorAll("[data-pick]").forEach(btn => {
          btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = parseInt(btn.getAttribute("data-pick"), 10);
            const groupIndex = groupByWagonId.get(id);
            if (!Number.isFinite(id) || groupIndex == null) return;
            openWagonGroupPopup(groupIndex, id, 0);
          };
        });
      }

      GROUPS.forEach((g, idx) => {
        const icon = L.divIcon({
          className: "",
          html: markerHtml(groupLabel(g.ids), WAGON_URL),
          iconSize: [44, 44],
          iconAnchor: [0, 0]
        });

        const marker = L.marker([g.y, g.x], { icon, draggable: false, keyboard: false }).addTo(wagonsLayer);
        markersByWagonGroupIndex.set(idx, marker);
        marker.on("click", () => openWagonGroupPopup(idx, g.ids[0], 0));
      });

      // ===== HORSES (group popups) =====
      function openHorseGroupPopup(groupIndex, activeId, photoIndex = 0){
        const g = HORSE_GROUPS[groupIndex];
        const marker = markersByHorseGroupIndex.get(groupIndex);
        if (!g || !marker) return;

        marker.bindPopup(horseGroupCardHtml(HORSES_DATA, g.ids, activeId, photoIndex), {
          closeButton: false,
          maxWidth: 600,
          autoPan: true,
          keepInView: true,
          autoPanPaddingTopLeft: [14, 110],
          autoPanPaddingBottomRight: [14, 14],
          className: "rdrPopup"
        }).openPopup();

        setTimeout(() => bindHorseGroupPopup(activeId, marker), 0);
      }

      function bindHorseGroupPopup(activeId, marker){
        const root = document.querySelector(`.rdrCard[data-hid="${activeId}"]`);
        if (!root) return;

        L.DomEvent.disableClickPropagation(root);
        L.DomEvent.disableScrollPropagation(root);

        const h = horseById.get(activeId);
        const photos = ((h?.photos && h.photos.length) ? h.photos : ["horse.png"]).map(resolveUrl).filter(Boolean);
        const getIdx = () => parseInt(root.getAttribute("data-idx"), 10) || 0;

        const imgEl = root.querySelector(".rdrImg");
        if (imgEl) imgEl.onerror = () => { imgEl.src = HORSE_URL; };

        const closeBtn = root.querySelector('[data-action="close"]');
        if (closeBtn) closeBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); marker.closePopup(); };

        const prevBtn = root.querySelector('[data-action="prev"]');
        const nextBtn = root.querySelector('[data-action="next"]');

        if (prevBtn && photos.length > 1){
          prevBtn.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            const idx = (getIdx() - 1 + photos.length) % photos.length;
            const groupIndex = groupByHorseId.get(activeId);
            openHorseGroupPopup(groupIndex, activeId, idx);
          };
        }

        if (nextBtn && photos.length > 1){
          nextBtn.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            const idx = (getIdx() + 1) % photos.length;
            const groupIndex = groupByHorseId.get(activeId);
            openHorseGroupPopup(groupIndex, activeId, idx);
          };
        }

        root.querySelectorAll("[data-pick]").forEach(btn => {
          btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = parseInt(btn.getAttribute("data-pick"), 10);
            const groupIndex = groupByHorseId.get(id);
            if (!Number.isFinite(id) || groupIndex == null) return;
            openHorseGroupPopup(groupIndex, id, 0);
          };
        });
      }

      HORSE_GROUPS.forEach((g, idx) => {
        const icon = L.divIcon({
          className: "",
          html: markerHtml(groupLabel(g.ids), HORSE_URL),
          iconSize: [44, 44],
          iconAnchor: [0, 0]
        });

        const marker = L.marker([g.y, g.x], { icon, draggable: false, keyboard: false }).addTo(horsesLayer);
        markersByHorseGroupIndex.set(idx, marker);
        marker.on("click", () => openHorseGroupPopup(idx, g.ids[0], 0));
      });

      // ===== Access Modal / Toggle =====
      const toggleBtn = document.getElementById("toggleBtn");
      const horseDot = document.getElementById("horseDot");

      const accessModal  = document.getElementById("accessModal");
      const accessClose  = document.getElementById("accessClose");
      const accessCancel = document.getElementById("accessCancel");
      const accessSubmit = document.getElementById("accessSubmit");
      const accessSubmitText = document.getElementById("accessSubmitText");
      const accessSpin   = document.getElementById("accessSpin");
      const accessCode   = document.getElementById("accessCode");
      const accessError  = document.getElementById("accessError");

      let horsesUnlocked = false;
      let accessBusy = false;

      function setUnlocked(v){
        horsesUnlocked = !!v;
        horseDot.classList.toggle("isHidden", horsesUnlocked); // hidden when unlocked
      }

      function setAccessBusy(v){
        accessBusy = !!v;
        accessSubmit.disabled = accessBusy;
        accessCancel.disabled = accessBusy;
        accessClose.disabled = accessBusy;
        accessCode.disabled = accessBusy;
        accessSpin.style.display = accessBusy ? "inline-block" : "none";
        accessSubmitText.textContent = accessBusy ? "–ü–µ—Ä–µ–≤—ñ—Ä—è—é..." : "–í—ñ–¥–∫—Ä–∏—Ç–∏";
      }

      function showAccessModal(){
        accessError.style.display = "none";
        accessCode.value = "";
        accessModal.style.display = "flex";
        accessModal.setAttribute("aria-hidden", "false");

        // hide main app for a11y
        appRoot.setAttribute("aria-hidden", "true");

        setAccessBusy(false);
        setTimeout(() => accessCode.focus(), 50);
      }
      function hideAccessModal(){
        if (accessBusy) return;
        accessModal.style.display = "none";
        accessModal.setAttribute("aria-hidden", "true");
        appRoot.removeAttribute("aria-hidden");
      }
      function denyHorsesGoBackToWagons(){
        currentMode = "wagons";
        applyMode();
      }

      accessClose.onclick = () => { hideAccessModal(); denyHorsesGoBackToWagons(); };
      accessCancel.onclick = () => { hideAccessModal(); denyHorsesGoBackToWagons(); };

      accessCode.addEventListener("keydown", (e) => {
        if (e.key === "Enter") accessSubmit.click();
        if (e.key === "Escape") { hideAccessModal(); denyHorsesGoBackToWagons(); }
      });

      accessModal.addEventListener("click", (e) => {
        if (e.target === accessModal){
          hideAccessModal();
          denyHorsesGoBackToWagons();
        }
      });

      accessSubmit.onclick = async () => {
        if (accessBusy) return;

        const code = normalizeCode(accessCode.value);
        if (!code){
          accessError.textContent = "–í–≤–µ–¥–∏ –∫–æ–¥.";
          accessError.style.display = "block";
          accessCode.focus();
          return;
        }

        accessError.style.display = "none";
        setAccessBusy(true);

        try{
          const out = await verifyWithWorker(code);

          if (!out.ok){
            accessError.textContent = out.error || "–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥.";
            accessError.style.display = "block";
            setAccessBusy(false);
            return;
          }

          if (out.token){
            setToken(out.token);
          }

          setUnlocked(true);
          hideAccessModal();
          applyMode();
        } catch {
          accessError.textContent = "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.";
          accessError.style.display = "block";
        } finally {
          setAccessBusy(false);
        }
      };

      // ===== Drawer render =====
      function renderDrawer(){
        if (currentMode === "wagons"){
          drawerTitleEl.textContent = "–°–ø–∏—Å–æ–∫ –ø–æ–≤–æ–∑–æ–∫";
          drawerList.innerHTML = WAGONS_DATA
            .slice()
            .sort((a,b) => a.id - b.id)
            .map(w => `
              <div class="wagonRow" data-type="wagon" data-id="${w.id}">
                <div class="wagonLeft">
                  <div class="wagonMain">#${w.id} ‚Äî ${esc(w.title || "–í–æ–∑–∏–∫")}</div>
                  <div class="wagonSub">${esc(w.city || "")}</div>
                </div>
                <div class="pricePill">${fmtPriceDot(w.price)} $</div>
              </div>
            `).join("");
        } else {
          drawerTitleEl.textContent = "–°–ø–∏—Å–æ–∫ –∫–æ–Ω–∏–∫—ñ–≤";
          drawerList.innerHTML = HORSES_DATA
            .slice()
            .sort((a,b) => a.id - b.id)
            .map(h => `
              <div class="wagonRow" data-type="horse" data-id="${h.id}">
                <div class="wagonLeft">
                  <div class="wagonMain">#${h.id} ‚Äî ${esc(h.fullName || "–ö—ñ–Ω—å")}</div>
                  <div class="wagonSub">${esc(h.breed || "")}</div>
                </div>
                <div class="pricePill">${fmtPriceDot(h.price)} $</div>
              </div>
            `).join("");
        }

        drawerList.querySelectorAll(".wagonRow").forEach(row => {
          row.onclick = () => {
            const type = row.getAttribute("data-type");
            const id = parseInt(row.getAttribute("data-id"), 10);
            if (!Number.isFinite(id)) return;

            closeDrawer();

            if (type === "wagon"){
              const groupIndex = groupByWagonId.get(id);
              if (groupIndex == null) return;
              const g = GROUPS[groupIndex];
              map.panTo([g.y, g.x], { animate: true, duration: 0.35 });
              setTimeout(() => openWagonGroupPopup(groupIndex, id, 0), 220);
            } else {
              if (!horsesUnlocked){
                showAccessModal();
                return;
              }
              const groupIndex = groupByHorseId.get(id);
              if (groupIndex == null) return;
              const g = HORSE_GROUPS[groupIndex];
              map.panTo([g.y, g.x], { animate: true, duration: 0.35 });
              setTimeout(() => openHorseGroupPopup(groupIndex, id, 0), 220);
            }
          };
        });
      }

      function applyMode(){
        map.closePopup();

        if (currentMode === "horses" && !horsesUnlocked){
          showAccessModal();
          return;
        }

        if (currentMode === "wagons"){
          if (map.hasLayer(horsesLayer)) map.removeLayer(horsesLayer);
          if (!map.hasLayer(wagonsLayer)) wagonsLayer.addTo(map);
          // text of first child stays; we don't touch your emoji order here
        } else {
          if (map.hasLayer(wagonsLayer)) map.removeLayer(wagonsLayer);
          if (!map.hasLayer(horsesLayer)) horsesLayer.addTo(map);
        }

        renderDrawer();
      }

      toggleBtn.onclick = () => {
        currentMode = (currentMode === "wagons") ? "horses" : "wagons";
        applyMode();
      };

      // ===== INIT access state from token =====
      (async function initAccess(){
        setUnlocked(false); // locked => red blink visible

        const token = getToken();
        if (!token){
          setUnlocked(false);
          return;
        }

        const st = await checkStatusWithWorker();
        if (st.ok){
          setUnlocked(true);
        } else {
          setToken("");
          setUnlocked(false);
        }
      })();

      applyMode();

      map.on('click', (e) => {
        if (!coordsEnabled) return;
        alert(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:\nY(lat): ${Math.round(e.latlng.lat)}\nX(lng): ${Math.round(e.latlng.lng)}`);
      });
    }
  </script>
</body>
</html>
